{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>Siirrämme tässä osassa fokuksen backendiin, eli palvelimella olevaan toiminnallisuuteen.</p>\n<p>Backendin toteutusympäristönä käytämme <a href=\"https://nodejs.org/en/\">Node.js</a>:ää, joka on melkein missä vaan, erityisesti palvelimilla ja omalla koneellasikin toimiva, Googlen <a href=\"https://developers.google.com/v8/\">chrome V8</a> -Javascriptmoottoriin perustuva Javascriptin suoritusympäristö.</p>\n<p>Kurssimateriaalia tehtäessä on ollut käytössä Node.js:n versio <i>v8.10.0</i>. Huolehdi että omasi on vähintään yhtä tuore (ks. komentoriviltä <em>node -v</em>).</p>\n<p>Kuten <a href=\"/osa1/javascriptia\">osassa 1</a> todettiin, selaimet eivät vielä osaa uusimpia Javascriptin ominaisuuksia ja siksi selainpuolen koodi täytyy kääntää eli <i>transpiloida</i> esim <a href=\"https://babeljs.io/\">babel</a>:illa. Backendissa tilanne on kuitenkin toinen, uusin Node hallitsee riittävissä määrin myös Javascriptin uusia versioita, joten suoritamme Nodella suoraan kirjoittamaamme koodia ilman transpilointivaihetta.</p>\n<p>Tavoitteenamme on tehdä <a href=\"/osa2\">osan 2</a> muistiinpanosovellukseen sopiva backend. Aloitetaan kuitenkin ensin perusteiden läpikäyminen toteuttamalla perinteinen \"hello world\"-sovellus.</p>\n<p><strong>Huomaa</strong>, että kaikki tässä osassa ja sen tehtävissä luotavat sovellukset eivät ole Reactia, eli emme käytä <i>create-reate-app</i>-sovellusta tämän osan sovellusten rungon alustamiseen.</p>\n<p>Osassa 2 oli jo puhe <a href=\"/osa2#npm\">npm</a>:stä, eli Javascript-projektien hallintaan liittyvästä, alunperin Node-ekosysteemistä kotoisin olevasta työkalusta. </p>\n<p>Mennään sopivaan hakemistoon ja luodaan projektimme runko komennolla <em>npm init</em>. Vastaillaan kysymyksiin sopivasti ja tuloksena on hakemiston juureen sijoitettu projektin tietoja kuvaava tiedosto <i>package.json</i></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"notebackend\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.0.1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"main\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"index.js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"echo \\\"Error: no test specified\\\" &amp;&amp; exit 1\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"author\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Matti Luukkainen\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"license\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"MIT\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Tiedosto määrittelee mm. että ohjelmamme käynnistyspiste on tiedosto <i>index.js</i>.</p>\n<p>Tehdään kenttään <i>scripts</i> pieni lisäys:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">{</span>\n  // <span class=\"token punctuation\">..</span>.\n  <span class=\"token string\">\"scripts\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token string\">\"start\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"node index.js\"</span>,</span>    <span class=\"token string\">\"test\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"echo \\\"Error: no test specified\\\" &amp;&amp; exit 1\"</span>\n  <span class=\"token punctuation\">}</span>,\n  // <span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Luodaan sitten sovelluksen ensimmäinen versio, eli projektin juureen sijoitettava tiedosto <i>index.js</i> ja sille seuraava sisältö:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hello world'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Voimme suorittaa ohjelman joko \"suoraan\" nodella, komentorivillä</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">node index.js</code></pre></div>\n<p>tai <a href=\"https://docs.npmjs.com/misc/scripts\">npm scriptinä</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> start</code></pre></div>\n<p>npm-skripti <i>start</i> toimii koska määrittelimme sen tiedostoon <i> package.json</i> </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">{</span>\n  // <span class=\"token punctuation\">..</span>.\n  <span class=\"token string\">\"scripts\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"start\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"node index.js\"</span>,\n    <span class=\"token string\">\"test\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"echo \\\"Error: no test specified\\\" &amp;&amp; exit 1\"</span>\n  <span class=\"token punctuation\">}</span>,\n  // <span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Vaikka esim. projektin suorittaminen onnistuukin suoraan käyttämällä komentoa <em>node index.js</em>, on npm-projekteille suoritettavat operaatiot yleensä tapana määritellä nimenomaan npm-skripteinä.</p>\n<p>Oletusarvoinen <i>package.json</i> määrittelee valmiiksi myös toisen yleisesti käytetyn npm-scriptin eli <em>npm test</em>. Koska projektissamme ei ole vielä testikirjastoa, ei <em>npm test</em> kuitenkaan tee vielä muuta kuin suorittaa komennon</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">echo</span> <span class=\"token string\">\"Error: no test specified\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">exit</span> 1</code></pre></div>\n<h3>Yksinkertainen web-palvelin</h3>\n<p>Muutetaan sovellus web-palvelimeksi:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hello World'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> port <span class=\"token operator\">=</span> <span class=\"token number\">3001</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Server running on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>port<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Kun sovellus käynnistuu, konsoliin tulostuu</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">Server running on port 3001</code></pre></div>\n<p>Voimme avata selaimella osoitteessa <a href=\"http://localhost:3001\">http://localhost:3001</a> olevan vaatimattoman sovelluksemme:</p>\n<picture><img src=\"/static/8836d8c6a93e804f6cbc73ff4d89913b/14be6/1.png\" srcset=\"/static/8836d8c6a93e804f6cbc73ff4d89913b/4cce7/1.png 200w,\n/static/8836d8c6a93e804f6cbc73ff4d89913b/bae5f/1.png 400w,\n/static/8836d8c6a93e804f6cbc73ff4d89913b/14be6/1.png 800w,\n/static/8836d8c6a93e804f6cbc73ff4d89913b/1b35a/1.png 1200w,\n/static/8836d8c6a93e804f6cbc73ff4d89913b/d20ef/1.png 1412w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Palvelin toimii itseasiassa täsmälleen samalla tavalla riippumatta urlin loppuosasta, eli myös sivun <a href=\"http://localhost:3001/foo/bar\">http://localhost:3001/foo/bar</a> sisältö on sama.</p>\n<p><strong>HUOM</strong> jos koneesi portti 3001 on jo jonkun sovelluksen käytössä, aiheuttaa käynnistäminen virheen:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">➜  hello <span class=\"token function\">npm</span> start\n\n<span class=\"token operator\">></span> hello@1.0.0 start /Users/mluukkai/opetus/_2019fullstack-koodit/osa3/hello\n<span class=\"token operator\">></span> node index.js\n\nServer running on port 3001\nevents.js:167\n      throw er<span class=\"token punctuation\">;</span> // Unhandled <span class=\"token string\">'error'</span> event\n      ^\n\nError: listen EADDRINUSE :::3001\n    at Server.setupListenHandle <span class=\"token punctuation\">[</span>as _listen2<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>net.js:1330:14<span class=\"token punctuation\">)</span>\n    at listenInCluster <span class=\"token punctuation\">(</span>net.js:1378:12<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Sammuta portissa 3001 oleva sovellus (edellisessä osassa json-server käynnistettiin porttiin 3001) tai määrittele sovellukselle jokin toinen portti.</p>\n<p>Tarkastellaan koodia hiukan. Ensimmäinen rivi</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>ottaa käyttöön Noden sisäänrakennetun <a href=\"https://nodejs.org/docs/latest-v8.x/api/http.html\">web-palvelimen</a> määrittelevän moduulin. Kyse on käytännössä samasta asiasta, mihin olemme selainpuolen koodissa tottuneet hieman syntaksiltaan erilaisessa muodossa:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> http <span class=\"token keyword\">from</span> <span class=\"token string\">'http'</span></code></pre></div>\n<p>Selaimen puolella käytetään (nykyään) ES6:n moduuleita, eli moduulit määritellään <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/export\">exportilla</a> ja otetaan käyttöön <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import\">importilla</a>.</p>\n<p>Node.js kuitenkin käyttää ns. <a href=\"https://en.wikipedia.org/wiki/CommonJS\">CommonJS</a>-moduuleja. Syy tälle on siinä, että Node-ekosysteemillä oli tarve moduuleihin jo kauan ennen kuin Javascript tuki kielen tasolla moduuleja. Node ei toistaiseksi tue ES-moduuleja, mutta tuki on todennäköisesti jossain vaiheessa <a href=\"https://nodejs.org/api/esm.html\">tulossa</a>.</p>\n<p>CommonJS-moduulit toimivat kohtuullisessa määrin samaan tapaan kuin ES6-moduulit, ainakin tämän kurssin tarpeiden puitteissa.</p>\n<p>Koodi jatkuu seuraavasti:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hello World'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>koodi luo <a href=\"https://nodejs.org/docs/latest-v8.x/api/http.html\">http</a>-palvelimen metodilla <em>createServer</em> web-palvelimen, jolle se rekisteröi <i>tapahtumankäsittelijän</i>, joka suoritetaan <i>jokaisen</i> osoitteen http:/localhost:3001 alle tulevan HTTP-pyynnön yhteydessä.</p>\n<p>Pyyntöön vastataan statuskoodilla 200, asettamalla <i>Content-Type</i>-headerille arvo <i>text/plain</i> ja asettamalla palautettavan sivun sisällöksi merkkijono <i>Hello World</i>.</p>\n<p>Viimeiset rivit sitovat muuttujaan <em>app</em> sijoitetun http-palvelimen kuuntelemaan porttiin 3001 tulevia HTTP-pyyntöjä:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> <span class=\"token number\">3001</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Server running on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Koska tällä kurssilla palvelimen rooli on pääasiassa tarjota frontille JSON-muotoista \"raakadataa\", muutetaan heti palvelinta siten, että se palauttaa kovakoodatun listallisen JSON-muotoisia muistiinpanoja:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">let</span> notes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    id<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    content<span class=\"token punctuation\">:</span> <span class=\"token string\">'HTML on helppoa'</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    date<span class=\"token punctuation\">:</span> <span class=\"token string\">'2017-12-10T17:30:31.098Z'</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    important<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    id<span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    content<span class=\"token punctuation\">:</span> <span class=\"token string\">'Selain pystyy suorittamaan vain javascriptiä'</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    date<span class=\"token punctuation\">:</span> <span class=\"token string\">'2017-12-10T18:39:34.091Z'</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    important<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    id<span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    content<span class=\"token punctuation\">:</span> <span class=\"token string\">'HTTP-protokollan tärkeimmät metodit ovat GET ja POST'</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    date<span class=\"token punctuation\">:</span> <span class=\"token string\">'2017-12-10T19:20:14.298Z'</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    important<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">]</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  response<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'application/json'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  response<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token keyword\">const</span> port <span class=\"token operator\">=</span> <span class=\"token number\">3001</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Server running on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>port<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Käynnistetään palvelin uudelleen (palvelin sammutetaan painamalla <em>ctrl</em> ja <em>c</em> yhtä aikaa konsolissa) ja refreshataan selain.</p>\n<p>Headerin <i>Content-Type</i> arvolla <i>application/json</i> kerrotaan, että kyse on JSON-muotoisesta datasta. Muuttujassa <em>notes</em> oleva taulukko muutetaan jsoniksi metodilla <em>JSON.stringify(notes)</em>.</p>\n<p>Kun avaamme selaimen, on tulostusasu sama kuin <a href=\"/osa2#datan-haku-palvelimelta\">osassa 2</a> käytetyn <a href=\"https://github.com/typicode/json-server\">json-serverin</a> tarjoamalla muistiinpanojen listalla:</p>\n<picture><img src=\"/static/71b094598cbcfc32c61b51a168ad4d82/14be6/2.png\" srcset=\"/static/71b094598cbcfc32c61b51a168ad4d82/4cce7/2.png 200w,\n/static/71b094598cbcfc32c61b51a168ad4d82/bae5f/2.png 400w,\n/static/71b094598cbcfc32c61b51a168ad4d82/14be6/2.png 800w,\n/static/71b094598cbcfc32c61b51a168ad4d82/1b35a/2.png 1200w,\n/static/71b094598cbcfc32c61b51a168ad4d82/aca5c/2.png 1402w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Voimme jo melkein ruveta käyttämään uutta backendiämme osan 2 muistiinpano-frontendin kanssa. Mutta vain <em>melkein</em>, sillä kun käynnistämme frontendin, tulee konsoliin virheilmoitus</p>\n<picture><img src=\"/static/35a4438293bb22dd200358359d58157a/14be6/3.png\" srcset=\"/static/35a4438293bb22dd200358359d58157a/4cce7/3.png 200w,\n/static/35a4438293bb22dd200358359d58157a/bae5f/3.png 400w,\n/static/35a4438293bb22dd200358359d58157a/14be6/3.png 800w,\n/static/35a4438293bb22dd200358359d58157a/1b35a/3.png 1200w,\n/static/35a4438293bb22dd200358359d58157a/9ee03/3.png 1600w,\n/static/35a4438293bb22dd200358359d58157a/be508/3.png 1918w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Syy virheelle selviää pian, parantelemme kuitenkin ensin koodia muilta osin.</p>\n<h3>Express</h3>\n<p>Palvelimen koodin tekeminen suoraan Noden sisäänrakennetun web-palvelimen <a href=\"https://nodejs.org/docs/latest-v8.x/api/http.html\">http</a>:n päälle on mahdollista, mutta työlästä, erityisesti jos sovellus kasvaa hieman isommaksi.</p>\n<p>Nodella tapahtuvaa web-sovellusten ohjelmointia helpottamaan onkin kehitelty useita <em>http</em>:tä miellyttävämmän ohjelmointirajapinnan tarjoamia kirjastoja. Näistä ylivoimaisesti suosituin on <a href=\"http://expressjs.com\">express</a>.</p>\n<p>Otetaan express käyttöön määrittelemällä se projektimme riippuvuudeksi komennolla</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> express --save</code></pre></div>\n<p>Riippuvuus tulee nyt määritellyksi tiedostoon <i>package.json</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  // ...\n  <span class=\"token property\">\"dependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"express\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.16.4\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Riippuvuuden koodi asentuu kaikkien projektin riippuvuuksien tapaan projektin juuressa olevaan hakemistoon <i>node_modules</i>. Hakemistosta löytyy expressin lisäksi suuri määrä muutakin tavaraa</p>\n<picture><img src=\"/static/da4cca859c66e0bf7d064455a105ad49/14be6/4.png\" srcset=\"/static/da4cca859c66e0bf7d064455a105ad49/4cce7/4.png 200w,\n/static/da4cca859c66e0bf7d064455a105ad49/bae5f/4.png 400w,\n/static/da4cca859c66e0bf7d064455a105ad49/14be6/4.png 800w,\n/static/da4cca859c66e0bf7d064455a105ad49/1b35a/4.png 1200w,\n/static/da4cca859c66e0bf7d064455a105ad49/2e309/4.png 1382w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Kyseessä ovat expressin riippuvuudet ja niiden riippuvuudet ym... eli projektimme <a href=\"https://lexi-lambda.github.io/blog/2016/08/24/understanding-the-npm-dependency-model/\">transitiiviset riippuvuudet</a>.</p>\n<p>Projektiin asentui expressin versio 4.16.4. Mitä tarkoittaa </i>package.json:issa</i> versiomerkinnän edessä oleva väkänen, eli miksi muoto on</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"express\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.16.4\"</span></code></pre></div>\n<p>npm:n yhteydessä käytetään ns. <a href=\"https://docs.npmjs.com/getting-started/semantic-versioning\">semanttista versiointia</a>.</p>\n<p>Merkintä <i>^4.16.4</i> tarkoittaa, että jos/kun projektin riippuvuudet päivitetään, asennetaan expressistä versio, joka on vähintään <i>4.16.4</i>, mutta asennetuksi voi tulla versio, jonka <i>patch</i> eli viimeinen numero tai <i>minor</i> eli keskimmäinen numero voi olla suurempi. Pääversio eli <i>major</i> täytyy kuitenkin olla edelleen sama.</p>\n<p>Voimme päivittää projektin riippuvuudet komennolla</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> update</code></pre></div>\n<p>Vastaavasti jos aloitamme projektin koodaamisen toisella koneella, saamme haettua ajantasaiset, <i>package.json</i>:in määrittelyn kanssa yhteensopivat riippuvuudet komennolla</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span></code></pre></div>\n<p>Jos riippuvuuden <i>major</i>-versionumero ei muutu, uudempien versioiden pitäisi olla <a href=\"https://en.wikipedia.org/wiki/Backward_compatibility\">taaksepäin yhteensopivia</a>, eli jos ohjelmamme käyttäisi tulevaisuudessa esim. expressin versiota 4.99.175, tässä osassa tehtävän koodin pitäisi edelleen toimia ilman muutoksia. Sen sijaan tulevaisuudessa joskus julkaistava express 5.0.0. <a href=\"https://expressjs.com/en/guide/migrating-5.html\">voi sisältää</a> sellaisia muutoksia, että koodimme ei enää toimisi.</p>\n<h3>Web ja express</h3>\n<p>Palataan taas sovelluksen ääreen ja muutetaan se muotoon:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> notes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">]</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;h1>Hello World!&lt;/h1>'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> <span class=\"token number\">3001</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Server running on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Jotta sovelluksen uusi versio saadaan käyttöön, on sovellus uudelleenkäynnistettävä.</p>\n<p>Sovellus ei muutu paljoa. Heti alussa otetaan käyttöön <em>express</em>, joka on tällä kertaa <i>funktio</i>, jota kutsumalla luodaan muuttujaan <em>app</em> sijoitettava express-sovellusta vastaava olio:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Seuraavaksi määritellään sovellukselle kaksi <i>routea</i>. Näistä ensimmäinen määrittelee tapahtumankäsittelijän, joka hoitaa sovelluksen juureen eli polkuun <i>/</i> tulevia HTTP GET -pyyntöjä:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;h1>Hello World!&lt;/h1>'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Tapahtumankäsittelijäfunktiolla on kaksi parametria. Näistä ensimmäinen eli <a href=\"http://expressjs.com/en/4x/api.html#req\">request</a> sisältää kaikki HTTP-pyynnön tiedot ja toisen parametrin <a href=\"http://expressjs.com/en/4x/api.html#res\">response</a>:n avulla määritellään, miten pyyntöön vastataan.</p>\n<p>Koodissa pyyntöön vastataan käyttäen <em>response</em>-olion metodia <a href=\"http://expressjs.com/en/4x/api.html#res.send\">send</a>, jonka kutsumisen seurauksena palvelin vastaa HTTP-pyyntöön lähettämällä vastaukseksi <em>send</em>:in parametrina olevan merkkijonon <em><h1>Hello World!</h1></em>. Koska parametri on merkkijono, tulee vastauksessa <em>content-type</em>-headerin arvoksi <em>text/html</em>, statuskoodiksi tulee oletusarvoisesti 200.</p>\n<p>Routeista toinen määrittelee tapahtumankäsittelijän, joka hoitaa sovelluksen polkuun <em>notes</em> tulevia HTTP GET -pyyntöjä:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Pyyntöön vastataan <em>response</em>-olion metodilla <a href=\"http://expressjs.com/en/4x/api.html#res.json\">json</a>, joka lähettää HTTP-pyynnön vastaukseksi parametrina olevaa Javascript-olioa (eli taulukkoa <em>notes</em>) vastaavan JSON-muotoisen merkkijonon. Express asettaa headerin <em>Content-type</em> arvoksi <em>application/json</em>.</p>\n<p>Pieni huomio JSON-muodossa palautettavasta datasta.</p>\n<p>Aiemmassa, pelkkää Nodea käyttämässä versiossa, jouduimme muuttamaan palautettavan datan json-muotoon metodilla <em>JSON.stringify</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">response<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Expressiä käytettäessä tämä ei ole tarpeen, sillä muunnos tapahtuu automaattisesti.</p>\n<p>Kannattaa huomata, että <a href=\"https://en.wikipedia.org/wiki/JSON\">JSON</a> on merkkijono, eikä Javascript-olio kuten muuttuja <em>notes</em>.</p>\n<p>Seuraava interaktiivisessa <a href=\"https://nodejs.org/docs/latest-v8.x/api/repl.html\">node-repl</a>:issä suoritettu kokeilu havainnollistaa asiaa:</p>\n<picture><img src=\"/static/ab5b5f7c5d8e4b01881bbd927f04ed43/14be6/5.png\" srcset=\"/static/ab5b5f7c5d8e4b01881bbd927f04ed43/4cce7/5.png 200w,\n/static/ab5b5f7c5d8e4b01881bbd927f04ed43/bae5f/5.png 400w,\n/static/ab5b5f7c5d8e4b01881bbd927f04ed43/14be6/5.png 800w,\n/static/ab5b5f7c5d8e4b01881bbd927f04ed43/833bb/5.png 998w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Saat käynnistettyä interaktiivisen node-repl:in kirjoittamalla komentoriville <em>node</em>. Esim. joidenkin komentojen toimivuutta on koodatessa kätevä tarkastaa konsolissa, suosittelen!</p>\n<h3>nodemon</h3>\n<p>Jos muutamme sovelluksen koodia, joudumme uudelleenkäynnistämään sovelluksen (eli ensin sammuttamaan konsolista <em>ctrl</em> ja <em>c</em> ja sitten käynnistämään uudelleen), jotta muutokset tulisivat voimaan. Verrattuna Reactin mukavaan workflowhun, missä selain päivittyi automaattisesti koodin muuttuessa tuntuu uudelleenkäynnistely kömpelöltä.</p>\n<p>Ongelmaan ratkaisu on <a href=\"https://github.com/remy/nodemon\">nodemon</a>:</p>\n<blockquote>\n<p>nodemon will watch the files in the directory in which nodemon was started, and if any files change, nodemon will automatically restart your node application.</p>\n</blockquote>\n<p>Asennetaan nodemon määrittelemällä se <em>kehitysaikaiseksi riippuvuudeksi</em> (development dependency) komennolla:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save-dev nodemon</code></pre></div>\n<p>Tiedoston <i>package.json</i> sisältö muuttuu seuraavasti:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">{</span>\n  //<span class=\"token punctuation\">..</span>.\n  <span class=\"token string\">\"dependencies\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"express\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"^4.16.4\"</span>\n  <span class=\"token punctuation\">}</span>,\n  <span class=\"token string\">\"devDependencies\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"nodemon\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"^1.13.3\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Jos nodemon-riippuvuus kuitenkin meni normaaliin \"dependencies\"-ryhmään, päivitä package.json manuaalisesti vastaamaan yllä näkyvää (versiot kuitenkin säilyttäen).</p>\n<p>Kehitysaikaisilla riippuvuuksilla tarkoitetaan työkaluja, joita tarvitaan ainoastaan sovellusta kehitettäessä, esim. testaukseen tai sovelluksen automaattiseen uudelleenkäynnistykseen kuten <em>nodemon</em>.</p>\n<p>Kun sovellusta suoritetaan tuotantomoodissa, eli samoin kun sitä tullaan suorittamaan tuotantopalvelimella (esim. Herokussa, mihin tulemme kohta siirtämään sovelluksemme), ei kehitysaikaisia riippuvuuksia tarvita.</p>\n<p>Voimme käynnistää ohjelman <em>nodemon</em>:illa seuraavasti:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">node_modules/.bin/nodemon index.js</code></pre></div>\n<p>Sovelluksen koodin muutokset aiheuttavat nyt automaattisen palvelimen uudelleenkäynnistymisen. Kannattaa huomata, että vaikka palvelin uudelleenkäynnistyy automaattisesti, selain täytyy kuitenkin refreshata, sillä toisin kuin Reactin yhteydessä, meillä ei nyt ole eikä tässä skenaariossa (missä palautamme JSON-muotoista dataa) edes voisikaan olla selainta päivittävää <a href=\"https://gaearon.github.io/react-hot-loader/getstarted/\">hot reload</a> -toiminnallisuutta.</p>\n<p>Komento on ikävä, joten määritellään sitä varten <em>npm-skripti</em> tiedostoon <i>package.json</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">{</span>\n  // <span class=\"token punctuation\">..</span>\n  <span class=\"token string\">\"scripts\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"start\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"node index.js\"</span>,\n    <span class=\"token string\">\"watch\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"nodemon index.js\"</span>,\n    <span class=\"token string\">\"test\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"echo \\\"Error: no test specified\\\" &amp;&amp; exit 1\"</span>\n  <span class=\"token punctuation\">}</span>,\n  // <span class=\"token punctuation\">..</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Skriptissä ei ole tarvetta käyttää nodemonin polusta sen täydellistä muotoa <em>node</em>modules/.bin/nodemon_ sillä <em>npm</em> osaa etsiä automaattisesti suoritettavaa tiedostoa kyseisestä hakemistosta.</p>\n<p>Voimme nyt käynnistää palvelimen sovelluskehitysmoodissa komennolla</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> run <span class=\"token function\">watch</span></code></pre></div>\n<p>Toisin kuin skriptejä <em>start</em> tai <em>test</em> suoritettaessa, joudumme sanomaan myös <em>run</em>.</p>\n<h3>REST</h3>\n<p>Laajennetaan sovellusta siten, että se toteuttaa samanlaisen RESTful-periaatteeseen nojaavan HTTP-rajapinnan kuin <a href=\"https://github.com/typicode/json-server#routes\">json-server</a>.</p>\n<p>Representational State Transfer eli REST on Roy Fieldingin vuonna 2000 ilmestyneessä <a href=\"https://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm\">väitöskirjassa</a> määritelty skaalautuvien web-sovellusten rakentamiseksi tarkoitettu arkkitehtuurityyli.</p>\n<p>Emme nyt rupea määrittelemään REST:iä Fieldingiläisittäin tai rupea väittämään mitä REST on tai mitä se ei ole vaan otamme hieman <a href=\"https://en.wikipedia.org/wiki/Representational_state_transfer#Applied_to_Web_services\">kapeamman näkökulman</a> miten REST tai RESTful API:t yleensä tulkitaan Web-sovelluksissa. Alkuperäinen REST-periaate ei edes sinänsä rajoitu Web-sovelluksiin.</p>\n<p>Mainitsimme jo <a href=\"/osa2/#rest-apin-k%C3%A4ytt%C3%B6\">edellisessä osassa</a>, että yksittäisiä asioita, meidän tapauksessamme muistiinpanoja kutsutaan RESTful-ajattelussa <em>resursseiksi</em>. Jokaisella resurssilla on URL eli sen yksilöivä osoite.</p>\n<p>Erittäin yleinen konventio on muodostaa resurssien yksilöivät URLit liittäen resurssityypin nimi ja resurssin yksilöivä tunniste.</p>\n<p>Oletetaan että palvelumme juuriosoite on <em>www.example.com/api</em></p>\n<p>Jos nimitämme muistiinpanoja <em>note</em>-resursseiksi, yksilöidään yksittäinen muistiinpano, jonka tunniste on 10 URLilla <em>www.example.com/api/notes/10</em>.</p>\n<p>Kaikkia muistiinpanoja edustavan kokoelmaresurssin URL taas on <em>www.example.com/api/notes</em></p>\n<p>Resursseille voi suorittaa erilaisia operaatiota. Suoritettavan operaation määrittelee HTTP-operaation tyyppi, jota kutsutaan usein myös <em>verbiksi</em>:</p>\n<table>\n<thead>\n<tr>\n<th>URL</th>\n<th>verbi</th>\n<th>toiminnallisuus</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>notes/10   </td>\n<td>GET</td>\n<td>hakee yksittäisen resurssin</td>\n</tr>\n<tr>\n<td>notes</td>\n<td>GET</td>\n<td>hakee kokoelman kaikki resurssit</td>\n</tr>\n<tr>\n<td>notes</td>\n<td>POST</td>\n<td>luo uuden resurssin pyynnön mukana olevasta datasta</td>\n</tr>\n<tr>\n<td>notes/10</td>\n<td>DELETE   </td>\n<td>poistaa yksilöidyn resurssin</td>\n</tr>\n<tr>\n<td>notes/10</td>\n<td>PUT</td>\n<td>korvaa yksilöidyn resurssin pyynnön mukana olevalla datalla</td>\n</tr>\n<tr>\n<td>notes/10</td>\n<td>PATCH</td>\n<td>korvaa yksilöidyn resurssin osan pyynnön mukana olevalla datalla</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>Näin määrittyy suurin piirtein asia, mitä REST kutsuu nimellä <a href=\"https://en.wikipedia.org/wiki/Representational_state_transfer#Architectural_constraints\">uniform interface</a>, eli jossain määrin yhtenäinen tapa määritellä rajapintoja, jotka mahdollistavat (tietyin tarkennuksin) järjestelmien yhteiskäytön.</p>\n<p>Tämänkaltaista tapaa tulkita REST:iä on nimitetty kolmiportaisella asteikolla <a href=\"https://martinfowler.com/articles/richardsonMaturityModel.html\">kypsyystason 2</a> REST:iksi. REST:in kehittäjän Roy Fieldingin mukaan tällöin kyseessä ei vielä ole ollenkaan asia, jota tulisi kutsua <a href=\"http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven\">REST-apiksi</a>. Maailman \"REST\"-apeista valtaosa ei täytäkään puhdasverisen Fieldingiläisen REST-apin määritelmää.</p>\n<p>Joissain yhteyksissä (ks. esim <a href=\"http://shop.oreilly.com/product/9780596529260.do\">Richardsom, Ruby: RESTful Web Services</a>) edellä esitellyn kaltaista suoraviivaisehkoa resurssien <a href=\"https://en.wikipedia.org/wiki/Create,_read,_update_and_delete\">CRUD</a>-tyylisen manipuloinnin mahdollistavaa API:a nimitetään REST:in sijaan <a href=\"https://en.wikipedia.org/wiki/Resource-oriented_architecture\">resurssipohjaiseksi</a> arkkitehtuurityyliksi. Emme nyt kuitenkaan takerru liian tarkasti määritelmällisiin asioihin vaan jatkamme sovelluksen parissa.</p>\n<h3>Yksittäisen resurssin haku</h3>\n<p>Laajennetaan nyt sovellusta siten, että se tarjoaa muistiinpanojen operointiin REST-rajapinnan. Tehdään ensin <a href=\"http://expressjs.com/en/guide/routing.html\">route</a> yksittäisen resurssin katsomista varten.</p>\n<p>Yksittäisen muistiinpanon identifioi URL, joka on muotoa <em>notes/10</em>, missä lopussa oleva numero vastaa resurssin muistiinpanon id:tä.</p>\n<p>Voimme määritellä expressin routejen poluille <a href=\"http://expressjs.com/en/guide/routing.html\">parametreja</a> käyttämällä kaksoispistesyntaksia:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> notes<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> note<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Nyt <code>app.get('/notes/:id', ...)</code> käsittelee kaikki HTTP GET -pyynnöt, jotka ovat muotoa <em>note/JOTAIN</em>, missä <em>JOTAIN</em> on mielivaltainen merkkijono.</p>\n<p>Polun parametrin <em>id</em> arvoon päästään käsiksi pyynnön tiedot kertovan olion <a href=\"http://expressjs.com/en/api.html#req\">request</a> kautta:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Jo tutuksi tulleella taulukon <em>find</em>-metodilla haetaan taulukosta parametria vastaava muistiinpano ja palautetaan se pyynnön tekijälle.</p>\n<p>Kun sovellusta testataan menemällä selaimella osoitteeseen <a href=\"http://localhost:3001/notes/1\">http://localhost:3001/notes/1</a>, havaitaan että se ei toimi, selain näyttää tyhjältä. Tämä on tietenkin softadevaajan arkipäivää, ja on ruvettava debuggaamaan.</p>\n<p>Vanha hyvä keino on alkaa lisäillä koodiin <em>console.log</em>-komentoja:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> notes<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> note<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Konsoliin tulostuu</p>\n<pre>\n1\nundefined\n</pre>\n<p>eli halutun muistiinpanon id välittyy sovellukseen aivan oikein, mutta <em>find</em> komento ei löydä mitään.</p>\n<p>Päätetään tulostella konsoliin myös <em>find</em>-komennon sisällä olevasta vertailijafunktiosta, joka onnistuu helposti kun tiiviissä muodossa oleva funktio <code>note => note.id === id</code> kirjoitetaan eksplisiittisen returnin sisältävässä muodossa:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> notes<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">typeof</span> note<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">typeof</span> id<span class=\"token punctuation\">,</span> note<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> note<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> id<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Jokaisesta vertailufunktion kutsusta tulostetaan nyt monta asiaa. Konsolin tulostus on seuraava:</p>\n<pre>\n1 'number' '1' 'string' false\n2 'number' '1' 'string' false\n3 'number' '1' 'string' false\n</pre>\n<p>ongelman syy selviää: muuttujassa <em>id</em> on tallennettuna merkkijono '1' kun taas muistiinpanojen id:t ovat numeroita. Javascriptissä === vertailu katsoo kaikki eri tyyppiset arvot oletusarvoisesti erisuuriksi, joten 1 ei ole '1'.</p>\n<p>Korjataan ongelma, muuttamalla parametrina oleva merkkijonomuotoinen id <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number\">numeroksi</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> notes<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> note<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ja nyt yksittäisen resurssin hakeminen toimii</p>\n<picture><img src=\"/static/17783e7bcea7e45ad96673e18d716d61/14be6/6.png\" srcset=\"/static/17783e7bcea7e45ad96673e18d716d61/4cce7/6.png 200w,\n/static/17783e7bcea7e45ad96673e18d716d61/bae5f/6.png 400w,\n/static/17783e7bcea7e45ad96673e18d716d61/14be6/6.png 800w,\n/static/17783e7bcea7e45ad96673e18d716d61/2d8e8/6.png 1140w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>toiminnallisuuteen jää kuitenkin pieni ongelma.</p>\n<p>Jos haemme muistiinpanoa sellaisella indeksillä, mitä vastaavaa muistiinpanoa ei ole olemassa, vastaa palvelin seuraavasti</p>\n<picture><img src=\"/static/78ffb79c0d882a8e470a1d75040978b3/14be6/7.png\" srcset=\"/static/78ffb79c0d882a8e470a1d75040978b3/4cce7/7.png 200w,\n/static/78ffb79c0d882a8e470a1d75040978b3/bae5f/7.png 400w,\n/static/78ffb79c0d882a8e470a1d75040978b3/14be6/7.png 800w,\n/static/78ffb79c0d882a8e470a1d75040978b3/1b35a/7.png 1200w,\n/static/78ffb79c0d882a8e470a1d75040978b3/9ee03/7.png 1600w,\n/static/78ffb79c0d882a8e470a1d75040978b3/e8248/7.png 1994w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>HTTP-statuskoodi on onnistumisesta kertova 200. Vastaukseen ei liity dataa, sillä headerin <em>content-length</em> arvo on 0, ja samaa todistaa selain: mitään ei näy.</p>\n<p>Syynä tälle käyttäytymiselle on se, että muuttujan <em>note</em> arvoksi tulee <em>undefined</em> jos muistiinpanoa ei löydy. Tilanne tulisi käsitellä palvelimella järkevämmin, eli statuskoodin 200 sijaan tulee vastata statuskoodilla <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5\">404 not found</a>.</p>\n<p>Tehdään koodiin muutos</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> notes<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> note<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Koska vastaukseen ei nyt liity mitään dataa käytetään statuskoodin asettavan metodin <a href=\"http://expressjs.com/en/4x/api.html#res.status\">status</a> lisäksi metodia <a href=\"http://expressjs.com/en/4x/api.html#res.end\">end</a> ilmoittamaan siitä, että pyyntöön tulee vastata ilman dataa.</p>\n<p>Koodin haarautumisessa hyväksikäytetään sitä, että mikä tahansa Javascript-olio on <a href=\"https://developer.mozilla.org/en-US/docs/Glossary/Truthy\">truthy</a>, eli katsotaan todeksi vertailuoperaatiossa. undefined taas on <a href=\"https://developer.mozilla.org/en-US/docs/Glossary/Falsy\">falsy</a> eli epätosi.</p>\n<p>Nyt sovellus toimii, eli palauttaa oikean virhekoodin. Sovellus ei kuitenkaan palauta mitään käyttäjälle näytettävää kuten web-sovellukset yleensä tekevät jos mennään osoitteeseen jota ei ole olemassa. Emme kuitenkaan tarvitse nyt mitään näytettävää, sillä REST API:t ovat ohjelmalliseen käyttöön tarkoitettuja rajapintoja ja pyyntöön liitetty virheestä kertova statuskoodi on riittävä.</p>\n<h3>Resurssin poisto</h3>\n<p>Toteutetaan seuraavaksi resurssin poistava route. Poisto tapahtuu tekemällä HTTP DELETE -pyyntö resurssin urliin:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  notes <span class=\"token operator\">=</span> notes<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> note<span class=\"token punctuation\">.</span>id <span class=\"token operator\">!==</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">204</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Jos poisto onnistuu, eli poistettava muistiinpano on olemassa, vastataan statuskoodilla <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.5\">204 no content</a> sillä mukaan ei lähetetä mitään dataa.</p>\n<p>Ei ole täyttä yksimielisyyttä siitä mikä statuskoodi DELETE-pyynnöstä pitäisi palauttaa jos poistettavaa resurssia ei ole olemassa. Vaihtoehtoja ovat lähinnä 204 ja 404. Yksinkertaisuuden vuoksi sovellus palauttaa nyt molemmissa tilanteissa statuskoodin 204.</p>\n<h3>Postman</h3>\n<p>Herää kysymys miten voimme testata poisto-operaatiota? HTTP GET -pyyntöjä on helppo testata selaimessa. Voisimme toki kirjoittaa Javascript-koodin, joka testaa deletointia, mutta jokaiseen mahdolliseen tilanteeseen testikoodinkaan tekeminen ei ole aina paras ratkaisu.</p>\n<p>On olemassa useita backendin testaamista helpottavia työkaluja, eräs näistä on edellisessä osassa nopeasti mainittu komentorivityökalu <a href=\"https://curl.haxx.se\">curl</a>.</p>\n<p>Käytetään nyt kuitenkin <a href=\"https://www.getpostman.com/\">postman</a>-nimistä sovellusta.</p>\n<p>Asennetaan postman ja kokeillaan</p>\n<picture><img src=\"/static/ad95f48faec1d584669581d00a0b8c1e/14be6/8.png\" srcset=\"/static/ad95f48faec1d584669581d00a0b8c1e/4cce7/8.png 200w,\n/static/ad95f48faec1d584669581d00a0b8c1e/bae5f/8.png 400w,\n/static/ad95f48faec1d584669581d00a0b8c1e/14be6/8.png 800w,\n/static/ad95f48faec1d584669581d00a0b8c1e/1b35a/8.png 1200w,\n/static/ad95f48faec1d584669581d00a0b8c1e/9ee03/8.png 1600w,\n/static/ad95f48faec1d584669581d00a0b8c1e/bbd02/8.png 1808w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Postmanin käyttö on tässä tilanteessa suhteellisen yksinkertaista, riittää määritellä url ja valita oikea pyyntötyyppi.</p>\n<p>Palvelin näyttää vastaavan oikein. Tekemällä HTTP GET osoitteeseen <em><a href=\"http://localhost:3001/notes\">http://localhost:3001/notes</a></em> selviää että poisto-operaatio oli onnistunut, muistiinpanoa, jonka id on 2 ei ole enää listalla.</p>\n<p>Koska muistiinpanot on talletettu palvelimen muistiin, uudelleenkäynnistys palauttaa tilanteen ennalleen.</p>\n<h3>Visual Studio Coden REST client</h3>\n<p>Jos käytät Visual Studio Codea, voit postmanin sijaan käyttää VS Coden\n<a href=\"https://marketplace.visualstudio.com/items?itemName=humao.rest-client\">REST client</a> -pluginia.</p>\n<p>Kun plugin on asennettu, on sen käyttö erittäin helppoa. Tehdään projektin juureen hakemisto <em>requests</em>, jonka sisään talletetaan REST Client -pyynnöt <em>.rest</em>-päätteisinä tiedostoina.</p>\n<p>Luodaan kaikki muistiinpanot hakevan pyynnön määrittelevä tiedosto <em>get</em>all<em>notes.rest</em></p>\n<p>![](../images/3/8a.pnng</p>\n<p>Klikkaamalla <em>Send Request</em> -tekstiä, REST client suorittaa määritellyn HTTP-pyynnön ja palvelimen vastaus avautuu editoriin:</p>\n<p>![](../images/3/8b.pnng</p>\n<h3>Datan vastaanottaminen</h3>\n<p>Toteutetaan seuraavana uusien muistiinpanojen lisäys, joka siis tapahtuu tekemällä HTTP POST -pyyntö osoitteeseen <em><a href=\"http://localhost:3001/notes\">http://localhost:3001/notes</a></em> ja liittämällä pyynnön mukaan eli <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec7.html#sec7\">bodyyn</a> luotavan muistiinpanon tiedot JSON-muodossa.</p>\n<p>Jotta pääsisimme pyynnön mukana lähetettyyn dataan helposti käsiksi, tarvitsemme <a href=\"https://github.com/expressjs/body-parser\">body-parser</a>-kirjaston apua.</p>\n<p>Otetaan body-parser käyttöön ja luodaan alustava määrittely HTTP POST -pyynnön käsittelyyn</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> bodyParser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'body-parser'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//...</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Tapahtumankäsittelijäfunktio pääsee dataan käsiksi viittaamalla <em>request.body</em>.</p>\n<p>Ilman body-parser-käyttöönottoa pyynnön kentän <em>body</em> arvo olisi ollut määrittelemätön. body-parserin toimintaperiaatteena on, että se ottaa pyynnön mukana olevan JSON-muotoisen datan, muuttaa sen Javascript-olioksi ja sijoittaa <em>request</em>-olion kenttään <em>body</em> ennen kuin routen käsittelijää kutsutaan.</p>\n<p>Toistaiseksi sovellus ei vielä tee vastaanotetulle datalle mitään muuta kuin tulostaa sen konsoliin ja palauttaa sen pyynnön vastauksessa.</p>\n<p>Ennen toimintalogiikan viimeistelyä varmistetaan ensin postmanilla, että lähetetty tieto menee varmasti perille. Pyyntötyypin ja urlin lisäksi on määriteltävä myös pyynnön mukana menevä data eli <em>body</em>:</p>\n<p>![](../assets/3/9.pngng\nNäyttää kuitenkin siltä, että mitään ei mene perille, palvelin vastaanottaa ainoastaan tyhjän olion. Missä on vika? Olemme unohtaneet määritellä headerille <em>Content-Type</em> oikean arvon:</p>\n<p>![](../assets/3/10.pnng</p>\n<p>Nyt kaikki toimii! Ilman oikeaa headerin arvoa palvelin ei osaa parsia dataa oikeaan muotoon. Se ei edes yritä arvailla missä muodossa data on, sillä potentiaalisia datan siirtomuotoja eli <em>Content-Typejä</em> on olemassa <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types\">suuri määrä</a>.</p>\n<p>Jos käytät VS Codea niin edellisessä luvussa esitelty REST client kannattaa asentaa viimeistään <em>nyt</em>. POST-pyyntö tehdään REST clientillä seuraavasti:</p>\n<p>![](../images/3/8c.pnng</p>\n<p>Eli pyyntöä varten on luotu oma tiedosto <em>new</em>note.rest_. Pyyntö on muotoiltu <a href=\"https://github.com/Huachao/vscode-restclient/blob/master/README.md#usage\">dokumentaation ohjetta</a> noudatellen.</p>\n<p>REST clientin eräs suuri etu postmaniin verrattuna on se, että pyynnöt saa kätevästi talletettua projektin repositorioon ja tällöin ne ovat helposti koko kehitystiimin käytössä. Postmanillakin on mahdollista tallettaa pyyntöjä, mutta tilanne menee helposti kaaoottiseksi etenkin jos työn alla on useita toisistaan riippumattomia projekteja.</p>\n<blockquote>\n<p><strong>Tärkeä sivuhuomio</strong></p>\n<p>Välillä debugatessa tulee vastaan tilanteita, joissa backendissä on tarve selvittää mitä headereja HTTP-pyynnöille on asetettu. Eräs menetelmä tähän on <em>request</em>-olion melko kehnosti nimetty metodi <a href=\"http://expressjs.com/en/4x/api.html#req.get\">get</a>, jonka avulla voi selvittää yksittäisen headerin arvon. <em>request</em>-oliolla on myös kenttä <em>headers</em>, jonka arvona ovat kaikki pyyntöön liittyvät headerit.</p>\n<p>Ongelmia voi esim syntyä jos jätät vahingossa VS REST clientillä ylimmän rivin ja headerit määrittelevien rivien väliin tyhjän rivin. Tällöin REST client tulkitsee, että millekään headerille ei aseteta arvoa ja näin backend ei osaa tulkita pyynnön mukana olevaa dataa JSON:iksi.</p>\n<p>Puuttuvan <em>content-type</em>-headerin ongelma selviää kun backendissa tulostaa pyynnön headerit esim. komennolla console.log(request.headers)</p>\n</blockquote>\n<p>Palataan taas sovelluksen pariin. Kun tiedämme, että sovellus vastaanottaa tiedon oikein, voimme viimeistellä sovelluslogiikan:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> maxId <span class=\"token operator\">=</span>\n    notes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n      <span class=\"token operator\">?</span> notes\n          <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=></span> n<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> a <span class=\"token operator\">-</span> b<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n  note<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> maxId <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n  notes <span class=\"token operator\">=</span> notes<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Uudelle muistiinpanolle tarvitaan uniikki id. Ensin selvitetään olemassaolevista id:istä suurin muuttujaan <em>maxId</em>. Uuden muistiinpanon id:ksi asetetaan sitten <em>maxId+1</em>. Tämä tapa ei ole itseasiassa kovin hyvä, mutta emme nyt välitä siitä sillä tulemme pian korvaamaan tavan miten muistiinpanot talletetaan.</p>\n<p>Tämän hetkisessä versiossa on vielä se ongelma, että voimme HTTP POST -pyynnöllä lisätä mitä tahansa kenttiä sisältäviä olioita. Parannellaan sovellusta siten, että kenttä <em>content</em> vaaditaan. Kentille <em>important</em> ja <em>date</em> asetetaan oletusarvot. Kaikki muut kentät hylätään:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">generateId</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> maxId <span class=\"token operator\">=</span>\n    notes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n      <span class=\"token operator\">?</span> notes\n          <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=></span> n<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> a <span class=\"token operator\">-</span> b<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> maxId <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span>content <span class=\"token operator\">===</span> undefined<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> <span class=\"token string\">'content missing'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    content<span class=\"token punctuation\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    important<span class=\"token punctuation\">:</span> body<span class=\"token punctuation\">.</span>important <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    date<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token function\">generateId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  notes <span class=\"token operator\">=</span> notes<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Tunnisteena toimivan id-kentän arvon generointilogiikka on eriytetty funktioon <em>generateId</em>.</p>\n<p>Jos kenttä <em>content</em> puuttuu, vastataan statuskoodilla <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1\">400 bad request</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span>content <span class=\"token operator\">===</span> undefined<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> <span class=\"token string\">'content missing'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Huomaa, että returnin kutsuminen on tärkeää, jos sitä ei tapahdu, jatkaa koodi suoritusta metodin loppuun asti ja virheellinen muistiinpano tallettuu tietokantaan!</p>\n<p>Jos content-kentällä on arvo, luodaan muistiinpano syötteen perusteella. Kuten edellisessä osassa mainitsimme, aikaleimoja ei kannata luoda selaimen koodissa, sillä käyttäjän koneen kellon aikaan ei voi luottaa. Aikaleiman eli kentän <em>date</em> arvon generointi tapahtuukin nyt palvelimen toimesta.</p>\n<p>Jos kenttä <em>important</em> puuttuu, asetetaan sille oletusarvo <em>false</em>. Oletusarvo generoidaan nyt hieman erikoisella tavalla:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">important<span class=\"token punctuation\">:</span> body<span class=\"token punctuation\">.</span>important <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>jos sovelluksen vastaanottamassa muuttujaan <em>body</em> talletetussa datassa on kenttä <em>important</em>, tulee lausekkeelle sen arvo. Jos kenttää ei ole olemassa, tulee lausekkeen arvoksi oikeanpuoleinen osa eli <em>important</em>.</p>\n<blockquote>\n<p>Jos ollaan tarkkoja, niin kentän <em>body.important</em> arvon ollessa <em>false</em>, tulee lausekkeen <code>body.important || false</code> arvoksi oikean puoleinen <em>false</em>...</p>\n</blockquote>\n<p>Sovelluksen tämän hetkinen koodi on kokonaisuudessaan <a href=\"https://github.com/FullStack-HY/part3-notes-backend/tree/part3-1\">githubissa</a></p>\n<p>Huomaa, että repositorion master-haarassa on myöhemmän vaiheen koodi, tämän hetken koodi on tagissa <a href=\"https://github.com/FullStack-HY/part3-notes-backend/tree/part3-1\">part3-1</a>:</p>\n<p>![](../master/3/1b.pnng</p>\n<p>Jos kloonaat projektin itsellesi, suorita komento <em>npm install</em> ennen käynnistämistä eli komentoa <em>npm start</em>.</p>\n<h3>Tehtäviä</h3>\n<p>Tee nyt tehtävät <a href=\"/teht%C3%A4v%C3%A4t#expressin-alkeet\">3.1-3.6</a></p>\n<h3>Huomioita HTTP pyyntötyyppien käytöstä</h3>\n<p><a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html\">HTTP-standardi</a> puhuu pyyntötyyppien yhteydessä kahdesta ominaisuudesta, <strong>safe</strong> ja <strong>idempotent</strong>.</p>\n<p>HTTP-pyynnöistä GET:in tulisi olla <em>safe</em>:</p>\n<blockquote>\n<p>In particular, the convention has been established that the GET and HEAD methods SHOULD NOT have the significance of taking an action other than retrieval. These methods ought to be considered \"safe\".</p>\n</blockquote>\n<p>Safety siis tarkoittaa, että pyynnön suorittaminen ei saa aiheuttaa palvelimelle <em>sivuvaikutuksia</em> eli esim. muuttaa palvelimen tietokannan tilaa, pyynnön tulee ainoastaan palauttaa palvelimella olevaa dataa.</p>\n<p>Mikään ei automaattisesti takaa, että GET-pyynnöt olisivat luonteeltaan <em>safe</em>, kyseessä onkin HTTP-standardin suositus palvelimien toteuttajille. RESTful-periaatetta noudattaessa GET-pyyntöjä käytetäänkin aina siten, että ne ovat safe.</p>\n<p>HTTP-standardi määrittelee myös pyyntötyypin <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.4\">HEAD</a>, jonka tulee olla safe. Käytännössä HEAD:in tulee toimia kuten GET, mutta se ei palauta vastauksenaan muuta kuin statuskoodin ja headerit, viestin bodyä HEAD ei palauta ollenkaan.</p>\n<p>HTTP-pyynnöistä muiden paitsi POST:in tulisi olla <em>idempotentteja</em>:</p>\n<blockquote>\n<p>Methods can also have the property of \"idempotence\" in that (aside from error or expiration issues) the side-effects of N > 0 identical requests is the same as for a single request. The methods GET, HEAD, PUT and DELETE share this property</p>\n</blockquote>\n<p>Eli jos pyynnöllä on sivuvaikutuksia, lopputulos on sama suoritetaanko pyyntö yhden tai useamman kerran.</p>\n<p>Esim. jos tehdään HTTP PUT pyyntö osoitteeseen <em>/notes/10</em> ja pyynnön mukana on <code>{ content: \"ei sivuvaikutuksia\", important: true }</code>, on lopputulos sama riippumatta siitä kuinka monta kertaa pyyntö suoritetaan.</p>\n<p>Kuten metodin GET <em>safety</em> myös <em>idempotence</em> on HTTP-standardin suositus palvelimien toteuttajille. RESTful-periaatetta noudattaessa GET, HEAD, PUT ja DELETE-pyyntöjä käytetäänkin aina siten, että ne ovat idempotentteja.</p>\n<p>HTTP pyyntötyypeistä POST on ainoa joka ei ole <em>safe</em> eikä <em>idempotent</em>. Jos tehdään 5 kertaa HTTP POST -pyyntö osoitteeseen <em>/notes</em> siten että pyynnön mukana on <code>{ content: \"monta samaa\", important: true }</code>, tulee palvelimelle 5 saman sisältöistä muistiinpanoa.</p>\n<h3>Middlewaret</h3>\n<p>Äsken käyttöönottamamme <a href=\"https://github.com/expressjs/body-parser\">body-parser</a> on terminologiassa niin sanottu <a href=\"http://expressjs.com/en/guide/using-middleware.html\">middleware</a>.</p>\n<p>Middlewaret ovat funktioita, joiden avulla voidaan käsitellä <em>request</em>- ja <em>response</em>-olioita.</p>\n<p>Esim. body-parser ottaa pyynnön mukana tulevan raakadatan <em>request</em>-oliosta, parsii sen Javascript-olioksi ja sijoittaa olion <em>request</em>:in kenttään <em>body</em></p>\n<p>Middlewareja voi olla käytössä useita jolloin ne suoritetaan peräkkäin siinä järjestyksessä kun ne on otettu koodissa käyttöön.</p>\n<p>Toteutetaan itse yksinkertainen middleware, joka tulostaa konsoliin palvelimelle tulevien pyyntöjen perustietoja.</p>\n<p>Middleware on funktio, joka saa kolme parametria:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">logger</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Method:'</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Path:  '</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Body:  '</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'---'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Middleware kutsuu lopussa parametrina olevaa funktiota <em>next</em>, jolla se siirtää kontrollin seuraavalle middlewarelle.</p>\n<p>Middleware otetaan käyttöön seuraavasti:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>logger<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Middlewaret suoritetaan siinä järjestyksessä, jossa ne on otettu käyttöön sovellusolion metodilla <em>use</em>. Middlewaret tulee myös määritellä ennen routeja jos ne halutaan suorittaa ennen niitä. On myös eräitä tapauksia, joissa middleware tulee määritellä vasta routejen jälkeen, käytännössä tällöin on kyse middlewareista, joita suoritetaan vain, jos mikään route ei käsittele HTTP-pyyntöä.</p>\n<p>Lisätään routejen jälkeen seuraava middleware, jonka ansiosta saadaan routejen käsittelemättömistä virhetilanteista JSON-muotoinen virheilmoitus:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">error</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> <span class=\"token string\">'unknown endpoint'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Tehtäviä</h3>\n<p>Tee nyt tehtävät <a href=\"/teht%C3%A4v%C3%A4t#lis%C3%A4%C3%A4-middlewareja\">3.7 ja 3.8</a></p>\n</div>","frontmatter":{"mainImage":{"publicURL":"/static/part-3-6502baf3ac1171cebf38f6bc8b3a36dc.svg"},"part":3,"letter":"a"}}},"pageContext":{"part":3,"letter":"a"}}