<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/0.cf666ebb1044c6f142ea.css">@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Mono:400,500,600);@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400);.element--flex{display:flex;flex-wrap:wrap}.element--space-around{justify-content:space-around}.element--space-between{justify-content:space-between}.element--column{flex-direction:column}.element--centered{align-items:center;justify-content:center!important}@media (min-width:992px){.element--centered-in-desktop{align-items:center;justify-content:center!important}}@media (min-width:992px){.element--horizontal-half{width:45%}}.element--auto-margin{margin:auto}.element--auto-bottom-margin{margin-bottom:auto}.element--flex-start{align-content:flex-start}.element--no-wrap{flex-wrap:nowrap}.element--relative{position:relative!important}.image__content{position:absolute;top:0;left:0;height:100%;width:100%;-o-object-fit:cover;object-fit:cover}.image--contain .image__content{-o-object-fit:contain;object-fit:contain}.image{overflow:hidden;width:100%;position:relative}@media (min-width:992px){.image{width:40%}}.image .image__container{height:0;position:relative;width:100%;padding-bottom:89.0625%}.image--circle{border-radius:50%}.image--circle .image__content{background-color:#e1e1e1}.image--square-big{width:100%}.image--square-big .image__container{width:100%;padding-bottom:100%}.image--extra-small{width:8%}.image--extra-small .image__container{width:100%;padding-bottom:100%}@media (max-width:639px){.image--extra-small{width:calc(33.33333% - 1rem)}}.image--small{width:15%}.image--small .image__container{width:100%;padding-bottom:100%}@media (max-width:639px){.image--small{width:calc(33.33333% - 1rem)}}.image--medium{width:50%}.image--medium .image__container{width:100%;padding-bottom:71.25%}.image--large{width:100%}@media (min-width:992px){.image--large{width:60%}}.image--large .image__container{padding-bottom:59.37%;width:100%}.image--full-width{width:100%}.image--full-width .image__container{padding-bottom:59.37%;width:100%}.image--actual-size{width:100%}.image--actual-size .image__container{height:0;position:relative;width:100%;padding-bottom:60%}.navigation{z-index:2;list-style:none;opacity:0;display:none;margin:0;padding:5%;flex-direction:column;justify-content:center;align-items:center;background:#e1e1e1;position:fixed;top:8%;right:5%;transition:opacity .3s ease-in-out;font-weight:200}@media (min-width:640px){.navigation{display:flex;opacity:1;padding:0;font-weight:400;position:static;background:none;overflow:hidden;flex-direction:row}}.navigation__toggle{z-index:3;position:absolute;top:0;right:0;width:50px;height:40px;cursor:pointer;border:none;background:none;outline:none;border-radius:4px}@media (min-width:640px){.navigation__toggle{display:none}}.navigation__mobile-logo{display:none}.navigation__toggle-icon{top:8px;left:10px}.navigation__toggle-icon,.navigation__toggle-icon:after,.navigation__toggle-icon:before{position:absolute;width:30px;height:3px;transition:all .3s ease;border-radius:4px;background-color:#33332d}.navigation__toggle-icon:after,.navigation__toggle-icon:before{content:"";display:block}.navigation__toggle-icon:before{top:10px}.navigation__toggle-icon:after{top:20px}.is-open--navigation{overflow:hidden}.is-open--navigation .navigation{opacity:1;display:unset}.is-open--navigation .navigation:before{content:"";background-color:#e1e1e1;position:absolute;width:25px;height:25px;top:-3px;right:13px;-webkit-transform:rotate(45deg);transform:rotate(45deg)}.is-open--navigation .navigation__mobile-logo{display:block;width:30px;height:30px;position:absolute;top:47px;left:5%}@media (min-width:640px){.is-open--navigation .navigation__mobile-logo{display:none}}.is-open--navigation .navigation__toggle-icon{-webkit-transform:translate3d(0,10px,0) rotate(45deg);transform:translate3d(0,10px,0) rotate(45deg)}.is-open--navigation .navigation__toggle-icon,.is-open--navigation .navigation__toggle-icon:after,.is-open--navigation .navigation__toggle-icon:before{background:#33332d}.is-open--navigation .navigation__toggle-icon:before{-webkit-transform:rotate(-45deg) translate3d(-5.71429px,-6px,0);transform:rotate(-45deg) translate3d(-5.71429px,-6px,0);opacity:0}.is-open--navigation .navigation__toggle-icon:after{-webkit-transform:translate3d(0,-19px,0) rotate(-90deg);transform:translate3d(0,-19px,0) rotate(-90deg)}.navigation__item{margin:22px 0;white-space:nowrap}.navigation__item:first-of-type{margin:0 0 22px}.navigation__item:last-of-type{margin:22px 0 0}@media (min-width:640px){.navigation__item{margin:0 30px;padding:0!important}.navigation__item:first-of-type{margin:0 30px 0 2rem}.navigation__item:last-of-type{margin:0 0 0 30px}}html{font-family:IBM Plex Mono,monospace;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:IBM Plex Mono,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em IBM Plex Mono,monospace;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:IBM Plex Mono,monospace;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{margin:2rem 0 -.5rem;font-size:1.38316rem}h3,h4{padding:0;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{margin:2rem 0 -1rem;font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}body,html{margin:0;padding:0;font-family:IBM Plex Mono,monospace;font-weight:500;color:#33332d;font-size:14px;line-height:1.555rem}@media (min-width:992px){body,html{font-size:18px}}p{margin:0;text-align:left;line-height:1.5em}a,p{color:#33332d}a{text-decoration:none}.link a{border-bottom:2px solid #e1e1e1}.link a:hover{background-color:#e1e1e1}.container{position:relative;margin:0 auto;display:flex;flex-wrap:wrap;justify-content:space-between;width:90%;max-width:1200px}@media (min-width:992px){.container--right{margin-right:5%;width:54%;max-width:719.9856px}}@media (min-width:992px) and (min-width:1200px){.container--right{margin-right:calc((100% - 1200px)/2)}}.hidden{display:none!important}.centered{text-align:center}@media (max-width:639px){.centered--mobile{justify-content:center;align-content:center;align-items:center}}.spacing{margin-top:2rem}@media (min-width:992px){.spacing{margin-top:5rem}}.spacing--small{margin-top:1rem}@media (min-width:992px){.spacing--small{margin-top:3.444rem}}.spacing--large{margin-top:4rem}@media (min-width:992px){.spacing--large{margin-top:10rem}}.spacing--extra-large{margin-top:4rem}@media (min-width:992px){.spacing--extra-large{margin-top:20rem}}.spacing--after{margin-bottom:2rem}@media (min-width:992px){.spacing--after{margin-bottom:5rem}}@media (min-width:992px){.spacing--after-small{margin-bottom:2.5rem}}.spacing--after-large{margin-bottom:4rem}@media (min-width:992px){.spacing--after-large{margin-bottom:10rem}}@media (max-width:991px){.spacing--mobile{margin-top:2rem}}.col-1{width:100%}@media (min-width:992px){.col-1{width:10%}}.col-2{width:100%}@media (min-width:992px){.col-2{width:20%}}.col-3{width:100%}@media (min-width:992px){.col-3{width:30%}}.col-4{width:100%}@media (min-width:992px){.col-4{width:40%}}.col-5{width:100%}@media (min-width:992px){.col-5{width:50%}}.col-6{width:100%}@media (min-width:992px){.col-6{width:60%}}.col-7{width:100%}@media (min-width:992px){.col-7{width:70%}}.col-8{width:100%}@media (min-width:992px){.col-8{width:80%}}.col-9{width:100%}@media (min-width:992px){.col-9{width:90%}}.col-10{width:100%}@media (min-width:992px){.col-10{width:100%}}@media (min-width:992px){.push-right-1{margin-left:10%}.push-right-2{margin-left:20%}.push-right-3{margin-left:30%}.push-right-4{margin-left:40%}.push-right-5{margin-left:50%}.push-left-1{margin-right:10%}.push-left-2{margin-right:20%}.push-left-3{margin-right:30%}.push-left-4{margin-right:40%}.push-left-5{margin-right:50%}.push-left{margin-right:auto}.push-right{margin-left:auto}}@media (max-width:991px){.col-1--mobile{width:10%}.col-2--mobile{width:20%}.col-3--mobile{width:30%}.col-4--mobile{width:40%}.col-5--mobile{width:50%}.col-6--mobile{width:60%}.col-7--mobile{width:70%}.col-8--mobile{width:80%}.col-9--mobile{width:90%}.col-10--mobile{width:100%}.order-0--mobile{order:0}.order-1--mobile{order:1}.order-2--mobile{order:2}.order-3--mobile{order:3}.order-4--mobile{order:4}.order-5--mobile{order:5}.hidden--mobile{display:none}}.centered-vertically{display:flex;flex-direction:column;justify-content:center}.nav-item-hover{text-decoration:none;color:#33332d;font-weight:500;padding:.2em}@media (min-width:640px){.nav-item-hover{font-weight:600;font-size:1.111rem}}.nav-item-hover:active,.nav-item-hover:focus,.nav-item-hover:hover{color:#fff;background-color:#33332d}.nav-item-hover:active,.nav-item-hover:focus{outline:2px solid #706be4}.flex-fix-aligning:after,.flex-fix-aligning:before{content:"";width:30%;order:2}.index__main-title{font-size:1.571rem}@media (min-width:992px){.index__main-title{font-size:3rem}}.auto-bottom-margin{margin-bottom:auto}@media (min-width:992px){.absolute-top-right--desktop{position:absolute;top:0;right:0}}@media (min-width:640px){.frontpage__hero .image{top:-2em}}@media (min-width:992px){.frontpage__hero{flex-direction:column}.frontpage__hero .image{top:4em}}.heading-font{font-family:IBM Plex Sans,monospace}.deprecate{position:fixed;bottom:0;z-index:100;left:0;right:0;padding:2rem;margin:1rem;border:2px solid #33332d;border-radius:5px;background:#fdf889}.deprecate a{font-weight:700;margin-left:.5rem}.header{position:-webkit-sticky;position:sticky;z-index:200;top:0;transition:top .2s ease-in-out;box-sizing:border-box;width:100%;padding-top:1.444rem;padding-bottom:1rem;transition:all .2s ease-in-out}.header__logo{margin:0 10px}.triple-border{position:relative;padding:2px;border-radius:5px 0;transition:color .1s ease-in-out,background-color .1s ease-in-out}.triple-border:after,.triple-border:before{content:"";border:2px solid #33332d;border-radius:5px;position:absolute;width:calc(100% + 5px);height:calc(100% + 5px)}.triple-border:before{left:0;top:0}.triple-border:after{bottom:0;right:0}.triple-border__container{overflow:hidden;border-radius:3px 0}.triple-border--large-margin{margin:13px;padding:3px}.triple-border--large-margin:after,.triple-border--large-margin:before{content:"";border-width:3px;border-radius:13px;width:calc(100% + 13px);height:calc(100% + 13px)}.triple-border--large-margin .triple-border__container{border-radius:10px 0}.triple-border__logo{padding:.2rem;font-size:1.111rem;font-weight:600}.triple-border__return-tasks{font-size:.9rem;padding:1rem .2rem}</style><style data-href="/app.f588656cc80a065e5f1e.css">code[class*=language-],pre[class*=language-]{color:#fff;background:none;text-shadow:0 -.1em .2em #000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}:not(pre)>code[class*=language-],pre[class*=language-]{background:#4d4033}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border:.3em solid #7a6652;border-radius:.5em;box-shadow:inset 1px 1px .5em #000}:not(pre)>code[class*=language-]{padding:.15em .2em .05em;border-radius:.3em;border:.13em solid #7a6652;box-shadow:inset 1px 1px .3em -.1em #000;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#998066}.namespace,.token.punctuation{opacity:.7}.token.boolean,.token.constant,.token.number,.token.property,.token.symbol,.token.tag{color:#d1949e}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#bde052}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f5b83d}.token.atrule,.token.attr-value,.token.keyword{color:#d1949e}.token.important,.token.regex{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.deleted{color:red}</style><style data-href="/component---src-templates-content-template-js.59a575ad88fdbaeba17d.css">@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Mono:400,500,600);@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400);.course{position:relative;width:100%}.course p{font-family:IBM Plex Sans,monospace}@media (min-width:640px){.course p{margin-left:1rem}}.course p:not(:last-of-type){margin-bottom:1rem}@media (min-width:640px){.course h1{margin-left:3rem}}.course h2,.course h3,.course h4{padding-bottom:2rem}@media (min-width:640px){.course h2,.course h3,.course h4,.course table{margin-left:1rem}}.course ul{font-family:IBM Plex Sans,monospace}@media (min-width:640px){.course ul{margin-left:2.2rem}}.course h2:not(:first-of-type){margin-top:2rem}.course pre{margin:2rem 0;background-color:#33332d;color:#fff}.course em{font-family:Courier;font-style:normal;background-color:hsla(0,0%,88.2%,.6);padding:1px 5px 2px}.course img{border:11px solid transparent}.course .banner,.course .container{position:static}.course .letter{width:4rem;height:4rem;border-width:5px;border-style:solid;border-radius:2.5rem;text-align:center;margin:1rem;line-height:1.3em;-webkit-transform:translate(-1rem);transform:translate(-1rem)}@media (min-width:640px){.course .letter{-webkit-transform:translate(-3rem,4.5rem);transform:translate(-3rem,4.5rem)}}.course .letter,.course h1{font-size:2.3rem;font-weight:700}.course-content a,.tasks a{border:0;border-bottom-width:2px;border-style:solid;padding:2px}.course-content{max-width:100%}.tasks a{border-color:#33332d!important}.tasks a:hover{background-color:#fff!important;color:#000!important}.gatsby-highlight-code-line{background-color:hsla(0,0%,88.2%,.3);display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:1em}code[class*=language-],pre[class*=language-]{text-shadow:none}.arrow-go-up{width:36px;height:36px;position:fixed;bottom:5%;right:5%;z-index:99999;cursor:pointer}@media (max-width:639px){.arrow-go-up{right:10%}}.arrow__container{position:relative}.arrow__container:not():first-child{background:none;background-color:none}@media (min-width:640px){.arrow__container:not():first-child{border-left:none}.arrow__container:not():first-child:before{content:"";background:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NzcuMTc1IDQ3Ny4xNzUiPjxwYXRoIGQ9Ik0zNjAuNzMxIDIyOS4wNzVsLTIyNS4xLTIyNS4xYy01LjMtNS4zLTEzLjgtNS4zLTE5LjEgMHMtNS4zIDEzLjggMCAxOS4xbDIxNS41IDIxNS41LTIxNS41IDIxNS41Yy01LjMgNS4zLTUuMyAxMy44IDAgMTkuMSAyLjYgMi42IDYuMSA0IDkuNSA0IDMuNCAwIDYuOS0xLjMgOS41LTRsMjI1LjEtMjI1LjFjNS4zLTUuMiA1LjMtMTMuOC4xLTE5eiIvPjwvc3ZnPg==) no-repeat;background-size:contain;position:absolute;top:0;left:0;height:100%;width:100%}}.arrows--horizontal{display:flex;position:relative;margin:0;align-items:flex-start}.arrow__wrapper{display:flex;justify-content:flex-start;align-items:center;margin:0}.arrow__wrapper:first-of-type{border-right:none;z-index:20}.arrow__wrapper:nth-of-type(n+2){margin-left:-4rem;z-index:10}.arrow__wrapper:nth-of-type(n+2) .arrow__rectangle{border-left:none;padding-left:4rem}.arrow__wrapper:nth-of-type(3){z-index:5}.arrow__wrapper:hover .arrow__point,.arrow__wrapper:hover .arrow__rectangle,.arrow__wrapper:hover .arrow__rectangle>a{background-color:#33332d!important;color:#fff!important}.arrow__rectangle{padding:1rem;justify-content:center;align-items:center;border:2px solid #33332d;border-right:none;z-index:2;overflow:hidden;font-family:IBM Plex Sans,monospace;position:relative}@media (max-width:991px){.arrow__rectangle{font-size:.7rem}}.arrow__rectangle .bold{font-weight:600}.arrow__rectangle--thick-border{border:3px solid #33332d;border-right:none}.arrow__point{padding:1.25rem;border:2px solid #33332d;border-bottom:none;border-left:none;-webkit-transform:translate(-1.3rem) rotate(45deg);transform:translate(-1.3rem) rotate(45deg);z-index:1;overflow:hidden}.arrow__point--thick-border{border:3px solid #33332d;border-bottom:none;border-left:none}.arrow__wrapper--stacked{display:flex;justify-content:flex-start;align-items:center;margin:auto auto auto 0}.arrow__wrapper--stacked:nth-of-type(n+2){margin-top:1rem}@media (min-width:640px){.arrow__wrapper--stacked:nth-of-type(n+2){margin-top:-2px}}.arrow__wrapper--stacked .arrow__rectangle{position:relative}@media (min-width:640px){.arrow__wrapper--stacked .arrow__rectangle{padding:1.25rem}}@media (min-width:992px){.arrow__wrapper--stacked .arrow__rectangle{padding:1rem}}.arrow__wrapper--stacked .arrow__point{padding:1.08rem;margin-left:2px}@media (min-width:640px){.arrow__wrapper--stacked .arrow__point{margin-left:unset;padding:1.25rem}}.arrow__wrapper--stacked:hover .arrow__point,.arrow__wrapper--stacked:hover .arrow__rectangle{background-color:#33332d!important}.arrow__wrapper--stacked:hover .arrow--stacked-letter,.arrow__wrapper--stacked:hover .arrow--stacked-title{color:#fff}.arrow--stacked-letter{margin-right:2rem}.arrow--stacked-title{white-space:nowrap;font-family:IBM Plex Mono,monospace}.arrow__container--with-link{width:100%!important}@media (max-width:639px){.breadcrumb .arrow__wrapper{padding:0}.breadcrumb .arrow__wrapper:not(:last-of-type):after{content:">";font-size:.7rem;font-weight:400;margin:0 .5rem}}.breadcrumb .arrow__wrapper:hover .arrow__point,.breadcrumb .arrow__wrapper:hover .arrow__rectangle{background-color:#33332d!important}.breadcrumb .arrow__wrapper:hover .arrow--stacked-letter,.breadcrumb .arrow__wrapper:hover .arrow--stacked-title{color:#fff}.breadcrumb .arrow__rectangle{position:relative}@media (max-width:639px){.breadcrumb .arrow__rectangle{border:none;padding:0;font-size:.7rem;white-space:nowrap;background-color:transparent!important;color:#33332d}}@media (max-width:639px){.breadcrumb .arrow__point{display:none}}.banner{display:flex;width:100%;align-items:center;position:relative;padding:2rem 0;background-color:#e1e1e1}@media (min-width:992px){.banner{padding:3.444rem 3.444rem 4.444rem}}.edit-link{border-bottom-width:3px;border-bottom-style:solid}@media (min-width:992px){#footer{align-items:center}}#footer .footer__navigation-link{font-size:1rem;line-height:18px;white-space:nowrap;font-family:IBM Plex Sans,monospace;margin-left:0!important}#footer .footer__navigation-link:nth-of-type(n+2){margin-top:2.142rem}@media (min-width:992px){#footer .footer__navigation{flex-direction:row;flex-wrap:nowrap;justify-content:flex-end}#footer .footer__navigation-link{margin-top:0!important;margin-bottom:auto}#footer .footer__navigation-link:nth-of-type(n+1){margin-right:2.877rem}#footer .footer__navigation-link:last-of-type{margin-right:0!important}}.prev-next__container .separator{display:none}@media (max-width:639px){.prev-next__container .separator{display:block;background-color:#33332d;width:2px}}.prev-next__container .prev b,.prev-next__container .prev p{text-align:right}@media (max-width:639px){.prev-next__container .prev p:before{content:"<";margin-right:1rem}}@media (max-width:639px){.prev-next__container .next p:after{content:">";margin-left:1rem}}.body-text:not(:last-of-type){margin-bottom:2.5rem}.body-text__title{color:#33332d;font-size:1.44rem;line-height:1.25em;font-weight:700;margin:0;position:relative;top:50%;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.body-text__content:not(:last-of-type){padding-bottom:2em}.bold{font-weight:700}.body-text--no-padding{padding:0!important}.scroll-navigation{font-size:16px;position:absolute;width:30%;left:0;top:198px;padding-right:1rem;z-index:199}@media (max-width:991px){.scroll-navigation{display:none}}.scroll-navigation li{list-style-type:none}.scroll-navigation li:hover{cursor:pointer}.scroll-navigation li:hover a{background-color:#33332d;color:#fff!important}.scroll-navigation li:before{content:"-"}.left-navigation-link{padding-left:1.2rem;text-indent:-1.2rem}.left-navigation-link:hover{background-color:#33332d!important;color:#fff!important}.level-h1{font-weight:700;padding-left:2.8rem;text-indent:-2.8rem}.level-h2{padding-left:1.6rem;text-indent:-1.6rem}.accordion__container{margin-bottom:1rem}.accordion__title{padding-left:2.149rem!important;padding-right:2.149rem!important;font-size:1.111rem!important;font-weight:600}.accordion{background-color:#fff;border:3px solid #33332d;border-radius:5px;color:#444;cursor:pointer;padding:1rem;width:100%;text-align:left;outline:none;font-size:15px;transition:max-width .4s}.accordion:hover,.active{background-color:#e1e1e1}.accordion:after{content:"\2795";font-size:1rem;float:right;margin-left:5px}.active{border-color:#fff}.active:after{content:"\2796"}.panel{background-color:#fff;transition:height .3s;transition-timing-function:ease-in-out;overflow:hidden}.accordion--side-navigation{width:100%;margin-left:unset}.accordion--side-navigation .accordion{border:none;padding:0!important;background-color:transparent!important;color:#33332d!important;border-radius:0}.accordion--side-navigation .accordion__title{font-size:16px!important;font-weight:unset;background-color:transparent}.accordion--side-navigation .accordion__title:hover{background-color:#33332d!important;color:#fff!important}.accordion--side-navigation .panel{padding:1rem 0 0!important;background-color:transparent}.accordion--side-navigation .panel ul{margin-left:1rem}.accordion--side-navigation .accordion:hover,.accordion--side-navigation .active{background-color:#33332d;color:#fff}.accordion--side-navigation .accordion:after,.accordion--side-navigation .active:after{content:""}.sub-header{color:#33332d;font-family:IBM Plex Mono,monospace;padding-bottom:1.357rem}@media (min-width:992px){.sub-header{padding-bottom:2.333rem}}</style><meta name="generator" content="Gatsby 2.0.53"/><title data-react-helmet="true">Fullstack osa8 |  | Fullstack 2019</title><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" property="og:title" content="Fullstack osa8 | "/><meta data-react-helmet="true" property="og:description" content=""/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Houston Inc. Consulting oy"/><meta data-react-helmet="true" name="twitter:title" content="Fullstack osa8 | "/><meta data-react-helmet="true" name="twitter:description" content=""/><meta data-react-helmet="true" name="keywords" content="Fullstack, "/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link as="script" rel="preload" href="/app-2c491ec1dd58eba53a73.js"/><link as="script" rel="preload" href="/1-dbb4ae5331675e10024f.js"/><link as="script" rel="preload" href="/component---src-templates-content-template-js-f6f93d2d008d670dc548.js"/><link as="script" rel="preload" href="/2-8cb475ac5ceeb60d8393.js"/><link as="script" rel="preload" href="/0-760c5ecb1cd33f9af131.js"/><link as="script" rel="preload" href="/3-99d9f492efaa243f0035.js"/><link as="script" rel="preload" href="/webpack-runtime-1a4685448f95cb2069ac.js"/><link rel="preload" href="/static/d/535/path---osa-8-fragmentit-ja-subskriptiot-ebd-f5b-Hlrc2I04uYjbthUcV1K91Vouw.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="header " style="background-color:white"><div class="container" style="align-items:center;justify-content:flex-start"><a class="header__logo" href="/"><div class="triple-border nav-item-hover " style="padding:0.2em"><div class="triple-border__container triple-border__logo" style="background-color:transparent">{() =&gt; fs}</div></div></a><div class="navigation__wrapper "><button aria-label="Navigation menu" aria-expanded="false" class="navigation__toggle"><div class="navigation__toggle-icon"></div></button><nav><ul class="navigation"><li class="navigation__item "><a class="nav-item-hover" href="/about">KURSSISTA</a></li><li class="navigation__item "><a class="nav-item-hover" href="/#course-contents">KURSSIN SISÄLTÖ</a></li><li class="navigation__item "><a class="nav-item-hover" href="/faq">FAQ</a></li></ul></nav></div></div></div><div class="deprecate"><div><p>Tämä on 3. periodilla pidetyn, jo päättyneen kurssin sisältö.</p><p><strong>Jos haluat suorittaa kurssin nyt</strong>, mene osoitteeseen<!-- --> <span class="link"><a href="https://fullstackopen-2019.github.io/">https://fullstackopen-2019.github.io/</a></span></p></div></div><div class="course-container spacing--after"><div class="banner " style="background-image:url(/static/part-8-1f98236965546b36c2a293574ec8b02a.svg);background-position:center center;background-size:50%;background-repeat:no-repeat;background-color:#82F7EB"><div class="container spacing--after"><div class="col-10 spacing--after"><div class="arrow__container arrows--horizontal breadcrumb"><div class="arrow__wrapper"><div class="arrow__rectangle  " style="background-color:#82F7EB;color:#33332d"><a href="/#course-contents">Fullstack</a></div><div class="arrow__point " style="background-color:#82F7EB;color:#33332d"></div></div><div class="arrow__wrapper"><div class="arrow__rectangle  " style="background-color:#82F7EB;color:#33332d"><a href="/osa8">osa 8</a></div><div class="arrow__point " style="background-color:#82F7EB;color:#33332d"></div></div><div class="arrow__wrapper"><div class="arrow__rectangle  " style="background-color:#33332d;color:white">Fragmentit ja subskriptiot</div><div class="arrow__point " style="background-color:#33332d;color:white"></div></div></div></div></div></div><div class="course "><div class="container element--flex element--relative"><div class="scroll-navigation col-2 spacing element--flex element--column" tag="ul"><a class="left-navigation-link" style="border-color:#82F7EB" href="/osa8/graph_ql_palvelin">a GraphQL-palvelin</a><a class="left-navigation-link" style="border-color:#82F7EB" href="/osa8/react_ja_graph_ql">b React ja GraphQL</a><a class="left-navigation-link" style="border-color:#82F7EB" href="/osa8/tietokanta_ja_kayttajien_hallinta">c Tietokanta ja käyttäjien hallinta</a><a class="left-navigation-link" style="border-color:#82F7EB" href="/osa8/kirjautuminen_ja_valimuistin_paivitys">d Kirjautuminen ja välimuistin päivitys</a><div class="accordion__container col-8 push-right-1 accordion--side-navigation"><button class="accordion accordion__title  " style="background-color:#82F7EB;border-color:#82F7EB">e Fragmentit ja subskriptiot</button><div class="panel" style="padding:;max-height:0;transition:max-height 0.2s ease-out"><ul></ul></div></div></div><div class="course-content col-6 push-right-3 element--auto-bottom-margin"><p class="col-1 letter" style="border-color:#82F7EB">e</p><h1 class="sub-header ">Fragmentit ja subskriptiot</h1></div></div><div class="container"><div class="course-content col-6 push-right-3">
<p>Kurssi lähestyy loppua, katsotaan lopuksi vielä muutamaa GraphQL:n liittyvää asiaa.</p>
<h3>fragmentit</h3>
<p>GraphQL:ssä on suhteellisen yleistä, että eri kyselyt palauttavat samanlaisia vastauksia. Esim. puhelinluettelossa yhden henkilön hakeva kysely</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">query <span class="token punctuation">{</span>
  <span class="token function">findPerson</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&quot;Pekka Mikkola&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name
    phone
    address<span class="token punctuation">{</span>
      street 
      city
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>ja kaikki henkilöt hakeva kysely</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">query <span class="token punctuation">{</span>
  allPersons <span class="token punctuation">{</span>
    name
    phone
    address<span class="token punctuation">{</span>
      street 
      city
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>palauttavat molemmat henkilöitä. Valitessaan palautettavia kenttiä, molemmat kyselyt joutuvat määrittelemään täsmälleen samat kentät. </p>
<p>Tälläisiä tilanteita voidaan yksinkertaistaa <a href="https://graphql.org/learn/queries/#fragments">fragmenttien</a> avulla. Määritellään kaikki henkilön tiedot valitseva fragmentti</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">fragment PersonDetails on Person <span class="token punctuation">{</span>
  name
  phone 
  address <span class="token punctuation">{</span>
    street 
    city
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Kyselyt voidan nyt tehdä fragmenttien avulla kompaktimmassa muodossa</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">query <span class="token punctuation">{</span>
  allPersons <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">    <span class="token operator">...</span>PersonDetails</span>  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

query <span class="token punctuation">{</span>
  <span class="token function">findPerson</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&quot;Pekka Mikkola&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">    <span class="token operator">...</span>PersonDetails</span>  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Fragmentteja <i><strong>ei määritellä</strong></i> GraphQL:n skeemassa, vaan kyselyn tekevän clientin puolella. Fragmenttien tulee olla määriteltynä siinä vaiheessa kun client käyttää kyselyssään niitä. </p>
<p>Voisimme periaatteessa määritellä fragmentin jokaisen kyselyn yhteydessä seuraavasti</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> <span class="token constant">ALL_PERSONS</span> <span class="token operator">=</span> gql<span class="token template-string"><span class="token string">`
{
  allPersons  {
    ...PersonDetails
  }
}
fragment PersonDetails on Person {
  name
  phone 
  address {
    street 
    city
  }
}
`</span></span></code></pre></div>
<p>Huomattavasti järkevämpää on kuitenkin määritellä fragmentti kertaalleen ja sijoittaa se muuttujaan</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> <span class="token constant">PERSON_DETAILS</span> <span class="token operator">=</span> gql<span class="token template-string"><span class="token string">`
fragment PersonDetails on Person {
  id
  name
  phone 
  address {
    street 
    city
  }
}
`</span></span></code></pre></div>
<p>Näin määritelty fragmentti voidaan upottaa kaikkiin sitä tarvitseviin kyselyihin ja mutaatioihin &quot;prosenttiaaltosulku&quot;-operaatiolla:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> <span class="token constant">ALL_PERSONS</span> <span class="token operator">=</span> gql<span class="token template-string"><span class="token string">`
{
  allPersons  {
    ...PersonDetails
  }
}
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PERSON_DETAILS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">  
`</span></span></code></pre></div>
<h3>Subscriptiot eli tilaukset</h3>
<p>GraphQL tarjoaa query- ja mutation-tyyppien lisäksi kolmannenkin operaatiotyypin <a href="https://www.apollographql.com/docs/react/advanced/subscriptions.html">subscriptioin</a>, jonka avulla clientit voivat <i>tilata</i> palvelimelta tiedotuksia palvelimelle tapahtuneista muutoksista.</p>
<p>Subscriptionit poikkeavatkin radikaalisti kaikesta, mitä kurssilla on tähän mennessä nähty. Toistaiseksi kaikki interaktio on koostunut selaimessa olevan React-sovelluksen palvelimelle tekemistä HTTP-pyynnöistä. Myös GraphQL:n queryt ja mutaatiot on hoidettu näin. Subscriptionien myötä tilanne käänyy päinvastaiseksi. Sen jälkeen kun selaimessa oleva sovellus on tehnyt tilauksen muutostiedoista, alkaa selain kuunnella palvelinta. Muutosten tullessa palvelin lähettää muutostiedon <i>kaikille sitä kuunteleville</i> selaimille.</p>
<p>Teknisesti ottaen HTTP-protokolla ei taivu hyvin palvelimelta selaimeen päin tapahtuvaan kommunikaatioon. Konepellin alla GraphQL käyttääkin <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API">WebSocketeja</a> hoitamaan tilauksista aiheutuvan kommunikaation.</p>
<h3>Tilaukset palvelimella</h3>
<p>Toteutetaan nyt sovellukseemme subscriptionit, joiden avulla palvelimelta on mahdollista tilata tieto puhelinluetteloon lisätyistä henkilöistä. </p>
<p>Palvelimen ei ole tarve kovin monille muutoksille. Skeemaan tarvitaan seuraava lisäys:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">type Subscription <span class="token punctuation">{</span>
  personAdded<span class="token punctuation">:</span> Person<span class="token operator">!</span>
<span class="token punctuation">}</span>    </code></pre></div>
<p>Eli kun uusi henkilö luodaan, palautetaan henkilön tiedot kaikille tilaajille.</p>
<p>Määritellylle tilaukselle <em>personAdded</em> tarvitaan resolveri. Myös lisäyksen tekevää resolveria <em>addPerson</em> on muutettava siten, että uuden henkilön lisäys aiheuttaa ilmoituksen tilauksen tehneille.</p>
<p>Muutokset ovat seuraavassa:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> <span class="token punctuation">{</span> PubSub <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;apollo-server&#x27;</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> pubsub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PubSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
  Mutation<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    addPerson<span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>root<span class="token punctuation">,</span> args<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>args <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> currentUser <span class="token operator">=</span> context<span class="token punctuation">.</span>currentUser

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationError</span><span class="token punctuation">(</span><span class="token string">&quot;not authenticated&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> person<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        currentUser<span class="token punctuation">.</span>friends <span class="token operator">=</span> currentUser<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span>
        <span class="token keyword">await</span> currentUser<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserInputError</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          invalidArgs<span class="token punctuation">:</span> args<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

<span class="gatsby-highlight-code-line">      pubsub<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#x27;PERSON_ADDED&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> personAdded<span class="token punctuation">:</span> person <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
      <span class="token keyword">return</span> person
    <span class="token punctuation">}</span><span class="token punctuation">,</span>  
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="gatsby-highlight-code-line">  Subscription<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    personAdded<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      subscribe<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> pubsub<span class="token punctuation">.</span><span class="token function">asyncIterator</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;PERSON_ADDED&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span></code></pre></div>
<p>Tilausten yhteydessä kommunikaatio tapahtuu <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">publish-subscribe</a>-periaatteella käyttäen rajapinnan <a href="https://www.apollographql.com/docs/graphql-subscriptions/setup.html#setup">PubSub</a> toteuttavaa olioa. Uuden henkilön lisäys <i>julkaisee</i> tiedon lisäyksestä kaikille muutokset tilanneille PubSubin metodilla <em>publish</em>. </p>
<p>Subscriptionin <em>personAdded</em> resolveri rekisteröi tiedotteista kiinnostuneet clientit palauttamalla niille sopivan <a href="https://www.apollographql.com/docs/graphql-subscriptions/subscriptions-to-schema.html">iteraattoriolion</a>.</p>
<p>Muutetaan palvelimen käynnistävää koodia seuraavasti</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token comment">// ...</span>

<span class="gatsby-highlight-code-line">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">,</span> subscriptionsUrl <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Server ready at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
<span class="gatsby-highlight-code-line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Subscriptions ready at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subscriptionsUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Nyt näemme, että palvelin kuuntelee subscriptioita osoitteessa <em>ws://localhost:4000/graphql</em></p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">Server ready at http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token regex">/localhost:4000/</span>
Subscriptions ready at ws<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">4000</span><span class="token operator">/</span>graphql</code></pre></div>
<p>Muita muutoksia palvelimeen ei tarvita. </p>
<p>Tilauksia on mahdollista testata GraphQL-playgroundin avulla seuraavasti:</p>
<picture><img style="border-color:#82F7EB" alt="fullstack content" src="/static/f0af07ed93701d5b67b6c6b62a5dc838/14be6/31.png"/></picture>
<p>Kun tilauksen &quot;play&quot;-painiketta painetaan, jää playground odottamaan tilaukseen tulevia vastauksia. </p>
<p>Backendin koodi on kokonaisuudessaan <a href="https://github.com/fullstack-hy2019/graphql-phonebook-backend/tree/part8-6">githubissa</a>, branchissa <i>part8-6</i>.</p>
<h3>Tilaukset clientissä</h3>
<p>Jotta saamme tilaukset käyttöön React-sovelluksessa, tarvitaan hieman enemmän muutoksia, erityisesti <a href="https://www.apollographql.com/docs/react/advanced/subscriptions.html#subscriptions-client">konfiguraatioiden osalta</a>. Tiedostossa <i>index.js</i> olevat konfiguraatiot on muokattava seuraavaan muotoon:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#x27;react&#x27;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#x27;react-dom&#x27;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&#x27;./App&#x27;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> ApolloProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;react-apollo&#x27;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApolloProvider <span class="token keyword">as</span> ApolloHooksProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;react-apollo-hooks&#x27;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> ApolloClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;apollo-client&#x27;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createHttpLink <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;apollo-link-http&#x27;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InMemoryCache <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;apollo-cache-inmemory&#x27;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> setContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;apollo-link-context&#x27;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> split <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;apollo-link&#x27;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> WebSocketLink <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;apollo-link-ws&#x27;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getMainDefinition <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;apollo-utilities&#x27;</span>

<span class="token keyword">const</span> wsLink <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketLink</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  uri<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`ws://localhost:4000/graphql`</span></span><span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> <span class="token punctuation">{</span> reconnect<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> httpLink <span class="token operator">=</span> <span class="token function">createHttpLink</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  uri<span class="token punctuation">:</span> <span class="token string">&#x27;http://localhost:4000/graphql&#x27;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> authLink <span class="token operator">=</span> <span class="token function">setContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token punctuation">{</span> headers <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&#x27;phonebook-user-token&#x27;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>headers<span class="token punctuation">,</span>
      authorization<span class="token punctuation">:</span> token <span class="token operator">?</span> <span class="token template-string"><span class="token string">`bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> link <span class="token operator">=</span> <span class="token function">split</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">{</span> query <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> kind<span class="token punctuation">,</span> operation <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getMainDefinition</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
    <span class="token keyword">return</span> kind <span class="token operator">===</span> <span class="token string">&#x27;OperationDefinition&#x27;</span> <span class="token operator">&amp;&amp;</span> operation <span class="token operator">===</span> <span class="token string">&#x27;subscription&#x27;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  wsLink<span class="token punctuation">,</span>
  authLink<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>httpLink<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApolloClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  link<span class="token punctuation">,</span>
  cache<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>ApolloProvider client<span class="token operator">=</span><span class="token punctuation">{</span>client<span class="token punctuation">}</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ApolloHooksProvider client<span class="token operator">=</span><span class="token punctuation">{</span>client<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ApolloHooksProvider<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>ApolloProvider<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#x27;root&#x27;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre></div>
<p>Jotta kaikki toimisi, on asennettava uusia riippuvuuksia:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">npm install <span class="token operator">--</span>save subscriptions<span class="token operator">-</span>transport<span class="token operator">-</span>ws apollo<span class="token operator">-</span>link<span class="token operator">-</span>ws</code></pre></div>
<p>Uudet konfiguraatiot johtuvat kahdesta muutostarpeesta. Simppelimpi näistä on tarve
<a href="/osa8/react_ja_graph_ql#react-apollo-hooks">palata malliin</a>, jossa voimme käyttää GraphQL:ää sekä hookien että render props -komponenttien kanssa (react-apollo-hooks ei vielä tue subscritpioneita):</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> ApolloProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;react-apollo&#x27;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApolloProvider <span class="token keyword">as</span> ApolloHooksProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;react-apollo-hooks&#x27;</span>

<span class="token comment">// ...</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>ApolloProvider client<span class="token operator">=</span><span class="token punctuation">{</span>client<span class="token punctuation">}</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ApolloHooksProvider client<span class="token operator">=</span><span class="token punctuation">{</span>client<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ApolloHooksProvider<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>ApolloProvider<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#x27;root&#x27;</span><span class="token punctuation">)</span></code></pre></div>
<p>Toinen konfuguraatiomuutos huomioi sen, että sovelluksella tulee nyt olla HTTP-yhteyden lisäksi websocket-yhteys GraphQL-palvelimelle:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> wsLink <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketLink</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  uri<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`ws://localhost:4000/graphql`</span></span><span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> <span class="token punctuation">{</span> reconnect<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> httpLink <span class="token operator">=</span> <span class="token function">createHttpLink</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  uri<span class="token punctuation">:</span> <span class="token string">&#x27;http://localhost:4000/graphql&#x27;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Tilaukset tehdään komponentin
<a href="https://www.apollographql.com/docs/react/advanced/subscriptions.html#subscription-component">Subscription</a> avulla.</p>
<p>Tehdään koodiin seuraavat muutokset:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Subscription <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;react-apollo&#x27;</span></span>
<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> <span class="token constant">PERSON_ADDED</span> <span class="token operator">=</span> gql<span class="token template-string"><span class="token string">`</span><span class="gatsby-highlight-code-line">subscription {</span><span class="gatsby-highlight-code-line">  personAdded {</span><span class="gatsby-highlight-code-line">    ...PersonDetails</span><span class="gatsby-highlight-code-line">  }</span><span class="gatsby-highlight-code-line">}</span><span class="gatsby-highlight-code-line"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PERSON_DETAILS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span><span class="gatsby-highlight-code-line">`</span></span></span>
<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token comment">// ...</span>
<span class="gatsby-highlight-code-line">      <span class="token operator">&lt;</span>Subscription</span><span class="gatsby-highlight-code-line">        subscription<span class="token operator">=</span><span class="token punctuation">{</span><span class="token constant">PERSON_ADDED</span><span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        onSubscriptionData<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">{</span>subscriptionData<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token operator">&gt;</span> </span><span class="gatsby-highlight-code-line">        <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">null</span><span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token operator">&lt;</span><span class="token operator">/</span>Subscription<span class="token operator">&gt;</span></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Kun puhelinluetteloon nyt lisätään henkilöitä, tapahtuupa se mistä tahansa, tulostuvat clientin konsoliin lisätyn henkilön tiedot:</p>
<picture><img style="border-color:#82F7EB" alt="fullstack content" src="/static/64d4686b8b189c7c32c4cfce62ec3f77/14be6/32.png"/></picture>
<p>Kun luetteloon lisätään uusi henkilö, palvelin lähettää siitä tiedot clientille ja komponentin <em>Subscription</em> attribuuttissa <em>onSubscriptionData</em> määriteltyä callback-funktiota kutsutaan antaen sille parametriksi palvelimelle lisätty henkilö. </p>
<p>Toinen tapa ottaa palvelimen lähettämää dataa vastaan olisi komponentin <em>Subscription</em> render prop -funktio, joka on nyt ainoastaan </p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">null</span></code></pre></div>
<p>sillä data on käytännöllisempää käsitellä callback-funktiossa.</p>
<p>Laajennetaan ratkaisua vielä siten, että uuden henkilön tietojen saapuessa henkilö lisätään Apollon välimuistiin, jolloin se renderöityy heti ruudulle. Koodissa on jouduttu huomioimaan se, että sovelluksen itsensä lisäämää henkilöä ei saa lisätä välimuistiin kahteen kertaan:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Subscription <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;react-apollo&#x27;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">const</span> <span class="token function-variable function">includedIn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">,</span> object<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> 
    <span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span>id<span class="token punctuation">)</span>    

  <span class="token keyword">const</span> addPerson <span class="token operator">=</span> <span class="token function">useMutation</span><span class="token punctuation">(</span><span class="token constant">CREATE_PERSON</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    onError<span class="token punctuation">:</span> handleError<span class="token punctuation">,</span>
    update<span class="token punctuation">:</span> <span class="token punctuation">(</span>store<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> dataInStore <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">readQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span> query<span class="token punctuation">:</span> <span class="token constant">ALL_PERSONS</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> addedPerson <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>addPerson</span><span class="gatsby-highlight-code-line">      </span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">includedIn</span><span class="token punctuation">(</span>dataInStore<span class="token punctuation">.</span>allPersons<span class="token punctuation">,</span> addedPerson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        dataInStore<span class="token punctuation">.</span>allPersons<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>addedPerson<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        client<span class="token punctuation">.</span><span class="token function">writeQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          query<span class="token punctuation">:</span> <span class="token constant">ALL_PERSONS</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          data<span class="token punctuation">:</span> dataInStore</span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span>    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token comment">// ...</span>
      <span class="token operator">&lt;</span>Subscription
        subscription<span class="token operator">=</span><span class="token punctuation">{</span><span class="token constant">PERSON_ADDED</span><span class="token punctuation">}</span>
        onSubscriptionData<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">{</span>subscriptionData<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> addedPerson <span class="token operator">=</span> subscriptionData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>personAdded
          <span class="token comment">// näytetään muualla tehty lisäys myös notifikaationa</span>
          <span class="token function">notify</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>addedPerson<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> added`</span></span><span class="token punctuation">)</span>

          <span class="token keyword">const</span> dataInStore <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">readQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span> query<span class="token punctuation">:</span> <span class="token constant">ALL_PERSONS</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">includedIn</span><span class="token punctuation">(</span>dataInStore<span class="token punctuation">.</span>allPersons<span class="token punctuation">,</span> addedPerson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dataInStore<span class="token punctuation">.</span>allPersons<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>addedPerson<span class="token punctuation">)</span>
            client<span class="token punctuation">.</span><span class="token function">writeQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              query<span class="token punctuation">:</span> <span class="token constant">ALL_PERSONS</span><span class="token punctuation">,</span>
              data<span class="token punctuation">:</span> dataInStore
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&gt;</span> 
        <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">null</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Subscription<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Clientin lopullinen koodi <a href="https://github.com/fullstack-hy2019/graphql-phonebook-frontend/tree/part8-9">githubissa</a>, branchissa <i>part8-9</i>.</p>
<h3>n+1-ongelma</h3>
<p>Laajennetaan vielä backendia hieman. Muutetaan skeemaa siten, että tyypille <i>Person</i> tulee kenttä <em>friendOf</em>, joka kertoo kenen kaikkien käyttäjien tuttavalistalla ko henkilö on.</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">type Person <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> String<span class="token operator">!</span>
  phone<span class="token punctuation">:</span> String
  address<span class="token punctuation">:</span> Address<span class="token operator">!</span>
  friendOf<span class="token punctuation">:</span> <span class="token punctuation">[</span>User<span class="token operator">!</span><span class="token punctuation">]</span><span class="token operator">!</span>
  id<span class="token punctuation">:</span> <span class="token constant">ID</span><span class="token operator">!</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Sovellukseen tulisi siis saada tuki esim. seuraavalle kyselylle:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">query <span class="token punctuation">{</span>
  <span class="token function">findPerson</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&quot;Leevi Hellas&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    friendOf<span class="token punctuation">{</span>
      username
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Koska <em>friendOf</em> ei ole tietokannassa olevien <i>Person</i>-olioiden sarake, on sille tehtävä oma resolveri, joka osaa selvittää asian. Tehdään aluksi tyhjän listan palauttava resolveri:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">Person<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  address<span class="token punctuation">:</span> <span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> 
      street<span class="token punctuation">:</span> root<span class="token punctuation">.</span>street<span class="token punctuation">,</span>
      city<span class="token punctuation">:</span> root<span class="token punctuation">.</span>city
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="gatsby-highlight-code-line">  friendOf<span class="token punctuation">:</span> <span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// return list of users </span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> <span class="token punctuation">[</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div>
<p>Resolverin parametrina <em>root</em> on se henkilöolio jonka tuttavalista on selvityksen alla, eli etsimme olioista <em>User</em> ne, joiden <em>friends</em>-listalle sisältyy <em>root.\</em>id_:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">  Person<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    friendOf<span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> friends <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        friends<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          $<span class="token keyword">in</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>root<span class="token punctuation">.</span>_id<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> 
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> friends
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div>
<p>Sovellus toimii nyt. </p>
<p>Voimme samantien tehdä monimutkaisempiakin kyselyitä. On mahdollista selvittää esim. kaikkien henkilöiden tuttavat:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">query <span class="token punctuation">{</span>
  allPersons <span class="token punctuation">{</span>
    name
    friendOf <span class="token punctuation">{</span>
      username
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Sovelluksessa on nyt kuitenkin yksi ongelma, tietokantakyselyjä tehdään kohtuuttoman paljon. Jos lisäämme palvelimen jokaiseen tietokantakyselyn tekevään kohtaan konsoliin tehtävän tulostuksen, huomaamme että jos tietokannassa on viisi henkilöä, tehdään seuraavat tietokantakyselyt: </p>
<pre>

Person.find
User.find
User.find
User.find
User.find
User.find
</pre>
<p>Eli vaikka pääasiallisesti tehdään ainoastaan yksi kysely, haetaan kaikki henkilöt, aiheuttaa jokainen henkilö yhden kyselyn omassa resolverissaan.</p>
<p>Kyseessä on ilmentymä kuuluisasta <a href="https://www.google.com/search?q=n%2B1+problem">n+1-ongelmasta</a>, joka ilmenee aika ajoin eri yhteyksissä, välillä salakavalastikin sovelluskehittäjän huomaamatta aluksi mitään.</p>
<p>Sopiva ratkaisutapa n+1-ongelmaan riippuu tilanteesta, usein se edellyttää jonkinlaisen liitoskyselyn tekemistä usean yksittäisen kyselyn sijaan.</p>
<p>Tilanteessamme helpoimman ratkaisun toisi se, että tallettaisimme <em>Person</em>-olioihin viitteet niistä käyttäjistä kenen ystävälistalla henkilö on:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    unique<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    minlength<span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  phone<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    minlength<span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  street<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    minlength<span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>  
  city<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    minlength<span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="gatsby-highlight-code-line">  friendOf<span class="token punctuation">:</span> <span class="token punctuation">[</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      type<span class="token punctuation">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      ref<span class="token punctuation">:</span> <span class="token string">&#x27;User&#x27;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">]</span><span class="token punctuation">,</span> </span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Tällöin voisimme tehdä &quot;liitoskyselyn&quot;, eli hakiessamme <em>Person</em>-oliot, voimme populoida niiden <em>friendOf</em>-kentät:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">Query<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  allPersons<span class="token punctuation">:</span> <span class="token punctuation">(</span>root<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>    
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;Person.find&#x27;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>args<span class="token punctuation">.</span>phone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">      <span class="token keyword">return</span> Person<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">&#x27;friendOf&#x27;</span><span class="token punctuation">)</span></span>    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> Person<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> phone<span class="token punctuation">:</span> <span class="token punctuation">{</span> $exists<span class="token punctuation">:</span> args<span class="token punctuation">.</span>phone <span class="token operator">===</span> <span class="token string">&#x27;YES&#x27;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="gatsby-highlight-code-line">      <span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">&#x27;friendOf&#x27;</span><span class="token punctuation">)</span></span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Muutoksen jälkeen erilliselle <em>friendOf</em>-kentän resolverille ei enää olisi tarvetta.</p>
<p>Kaikkien henkilöiden kysely <i>ei aiheuta</i> n+1-ongelmaa, jos kyselyssä pyydetään esim. ainoastaan nimi ja puhelinnumero:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">query <span class="token punctuation">{</span>
  allPersons <span class="token punctuation">{</span>
    name
    phone
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Jos kyselyä <em>allPersons</em> muokataan tekemään liitoskysely sen varalta, että se aiheuttaa välillä n+1-ongelman, tulee kyselystä hieman raskaampi niissäkin tapaukisssa, joissa henkilöihin liittyviä käyttäjiä ei tarvita. Käyttämällä resolverifunktioiden <a href="https://www.apollographql.com/docs/apollo-server/essentials/data.html#type-signature">neljättä parametria</a> olisi kyselyn toteutusta mahdollista optimoida vieläkin pidemmälle. Neljännen parametrin avulla on mahdollista tarkastella itse kyselyä, ja näin liitoskysely voitaisiin tehdä ainoastaan niissä tapauksissa, joissa on n+1-ongelman uhka. Tämänkaltaiseen optimointiin ei toki kannata lähteä ennen kun on varmaa, että se todellakin kannattaa. </p>
<p><a href="https://en.wikiquote.org/wiki/Donald_Knuth">Donald Knuthin sanoin</a>:</p>
<blockquote>
<p><i>Programmers waste enormous amounts of time thinking about, or worrying about, the speed of noncritical parts of their programs, and these attempts at efficiency actually have a strong negative impact when debugging and maintenance are considered. We should forget about small efficiencies, say about 97% of the time: <strong>premature optimization is the root of all evil.</strong></i></p>
</blockquote>
<p>Erään varteenotettavan ratkaisun monien muiden seikkojen lisäksi n+1-ongelmaan tarjoaa
Facebookin kehittämä <a href="https://github.com/facebook/dataloader">dataloader</a>-kirjasto, dataloaderin käytöstä  Apollo serverin kanssa <a href="https://www.robinwieruch.de/graphql-apollo-server-tutorial/#graphql-server-data-loader-caching-batching">täällä</a> ja <a href="http://www.petecorey.com/blog/2017/08/14/batching-graphql-queries-with-dataloader/">täällä</a>.</p>
<h3>Loppusanat</h3>
<p>Tässä osassa rakentamamme sovellus ei ole optimaalisella tavalla strukturoitu: skeeman, kyselyiden ja mutaatioiden määrittely olisi ainakin syytä siirtää muualle sovelluskoodin seasta. Esimerkkejä GraphQL-sovellusten parempaan strukturointiin löytyy internetistä, esim. serveriin
<a href="https://blog.apollographql.com/modularizing-your-graphql-schema-code-d7f71d5ed5f2">täältä</a> ja clientiin <a href="https://medium.com/@peterpme/thoughts-on-structuring-your-apollo-queries-mutations-939ba4746cd8">täältä</a>.</p>
<p>GraphQL on jo melko iäkäs teknologia, se on ollut Facebookin sisäisessä käytössä jo vuodesta 2012 lähtien, teknologian voi siis todeta olevan &quot;battle tested&quot;. Facebook julkaisi GraphQL:n vuonna 2015 ja se on pikkuhiljaa saanut enenevissä määrin huomiota ja nousee ehkä lähivuosina uhmaamaan REST:in valta-asemaa. REST:in <a href="https://www.stridenyc.com/podcasts/52-is-2018-the-year-graphql-kills-rest">kuolemaakin</a> on jo ennusteltu. Vaikka se ei tulekaan ihan heti tapahtumaan, on GraphQL ehdottomasti <a href="https://blog.graphqleditor.com/javascript-predictions-for-2019-by-npm/">tutustumisen arvoinen</a>.</p>
</div></div>
<div class="banner spacing spacing--after tasks" style="background-color:#82F7EB"><div class="container"><div class="course-content col-6 push-right-3" style="border-color:#82F7EB;background-color:transparent">
<h3>Tehtäviä</h3>
<h4>8.23: Subscriptionit palvelin</h4>
<p>Tee palvelimelle toteutus subscriptiolle <em>bookAdded</em>, joka palauttaa tilaajilleen lisättyjen kirjojen tiedot.</p>
<h4>8.24: Subscriptionit client, osa 1</h4>
<p>Ota clientillä käyttöön subscriptiot ja tilaa <em>bookAdded</em>. Uusien kirjojen tullessa anna ilmoitus käyttäjälle. Mikä tahansa menetelmä käy, voit käyttää esim. funktiota <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/alert">window.alert</a>.</p>
<h4>8.25: Subscriptionit client, osa 2</h4>
<p>Pidä sovelluksen käyttöliittymä ajantasaisena, kun palvelin tiedottaa uusista kirjoista.</p>
<h4>8.26: n+1</h4>
<p>Ratkaise haluamallasi menetelmällä seuraavaa kyselyä vaivaava n+1-ongelma:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">query <span class="token punctuation">{</span>
  allAuthors <span class="token punctuation">{</span>
    name 
    bookCount
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
</div></div></div></div><div class="container spacing element--flex element--centered"><a class="edit-link" target="__BLANK" href="https://github.com/fullstack-hy2019/fullstack-hy2019.github.io/edit/source/src/content/osa8/osa8e.md">Ehdota muutosta materiaalin sisältöön</a></div><div class="container spacing spacing--after-large prev-next__container "><a class="col-4--mobile push-right-1 prev" href="/osa8/kirjautuminen_ja_valimuistin_paivitys"><div class=" element--flex element--column"><p>Osa <!-- -->8d</p><b>Edellinen osa</b></div></a><a class="col-4--mobile push-left-1 next" href="/osa9"><div class=" element--flex element--column"><p>Osa <!-- -->9</p><b>Seuraava osa</b></div></a></div></div><div class="container spacing--after-small spacing--mobile element--flex" id="footer"><div class="col-5 col-10--mobile order-2--mobile footer__links element--flex element--space-between"><a href="https://www.helsinki.fi/" class="col-5 col-4--mobile spacing--mobile"><div class="image col-6 image--contain"><div class="image__container"><img style="background-color:;background-opacity:0.5" class="image__content" src="/static/hgin_yliopisto-30c68104749d830b6cef6ea8c6339b16.png" alt="Helsingin yliopiston logo"/></div></div></a><a href="https://www.houston-inc.com/" class="col-5 col-4--mobile spacing--mobile"><div class="image col-6 image--contain"><div class="image__container"><img style="background-color:;background-opacity:0.5" class="image__content" src="/static/houston_logo-356bd2a9a75b44bdf7897b2cdd387600.png" alt="Houston inc. logo"/></div></div></a></div><div class="col-5 col-5--mobile order-1--mobile footer__navigation element--flex"><a class="footer__navigation-link nav-item-hover col-10--mobile" style="margin-left:4.5rem" href="/about">KURSSISTA</a><a class="footer__navigation-link nav-item-hover col-10--mobile" style="margin-left:4.5rem" href="/#course-contents">KURSSIN SISÄLTÖ</a><a class="footer__navigation-link nav-item-hover col-10--mobile" style="margin-left:4.5rem" href="/faq">FAQ</a></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-content-template-js","jsonName":"osa-8-fragmentit-ja-subskriptiot-ebd","path":"/osa8/fragmentit_ja_subskriptiot"};window.dataPath="535/path---osa-8-fragmentit-ja-subskriptiot-ebd-f5b-Hlrc2I04uYjbthUcV1K91Vouw";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.f588656cc80a065e5f1e.css","/app-2c491ec1dd58eba53a73.js"],"component---src-templates-part-intro-template-js":["/component---src-templates-part-intro-template-js.f89e77c0788c3b42eb99.css","/component---src-templates-part-intro-template-js-99c3379e0c85f98af85b.js"],"component---src-templates-content-template-js":["/component---src-templates-content-template-js.59a575ad88fdbaeba17d.css","/component---src-templates-content-template-js-f6f93d2d008d670dc548.js"],"component---src-pages-404-js":["/component---src-pages-404-js.8d4a7977feb76fc76984.css","/component---src-pages-404-js-64d6fadd34eefb01c89d.js"],"component---src-pages-about-js":["/component---src-pages-about-js.9b307033bd4c3b127e05.css","/component---src-pages-about-js-a186c5428b37a4f3fc57.js"],"component---src-pages-companies-js":["/component---src-pages-companies-js.150fce7cfbe4cb867585.css","/component---src-pages-companies-js-0c6d541d51f8a8346648.js"],"component---src-pages-faq-js":["/component---src-pages-faq-js.97fa9f467f8483b003af.css","/component---src-pages-faq-js-140f22441dedbc75968b.js"],"component---src-pages-index-js":["/component---src-pages-index-js.54fb40b9e036e2b0b9a4.css","/component---src-pages-index-js-82209c88a01109fa12ff.js"]};/*]]>*/</script><script src="/webpack-runtime-1a4685448f95cb2069ac.js" async=""></script><script src="/3-99d9f492efaa243f0035.js" async=""></script><script src="/0-760c5ecb1cd33f9af131.js" async=""></script><script src="/2-8cb475ac5ceeb60d8393.js" async=""></script><script src="/component---src-templates-content-template-js-f6f93d2d008d670dc548.js" async=""></script><script src="/1-dbb4ae5331675e10024f.js" async=""></script><script src="/app-2c491ec1dd58eba53a73.js" async=""></script></body></html>